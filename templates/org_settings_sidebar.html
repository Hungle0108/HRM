<div class="settings-sidebar">
    <div class="sidebar-header">
        <h1 class="sidebar-title">Organization settings</h1>
        <div class="search-container"> 
        
            <input type="text" class="search-input" placeholder="Search">
            <span class="search-icon">üîç</span>
        </div>
    </div>
    <nav class="settings-nav">
        <!-- Organization & security section -->
        <div class="nav-section">
            <div class="section-title">Organization & security</div>
            <div class="nav-item expandable" data-section="organization">
                <div class="nav-item-content">
                    <div class="nav-icon icon-organization"></div>
                    <span>Organization</span>
                    <span class="dropdown-arrow">
                        <img class="arrow-down" src="/static/images/angle-small-down.png" alt="Expand">
                        <img class="arrow-up" src="/static/images/angle-small-up.png" alt="Collapse">
                    </span>
                </div>
            </div>
            <div class="nav-subitems" data-parent="organization">
                <div class="nav-subitem{% if active_page == 'analytics' %} active{% endif %}"><a href="#">Analytics</a></div>
                <div class="nav-subitem{% if active_page == 'billing' %} active{% endif %}"><a href="#">Billing & payments</a></div>
                <div class="nav-subitem{% if active_page == 'branding' %} active{% endif %}"><a href="#">Custom branding</a></div>
                <div class="nav-subitem{% if active_page == 'entities' %} active{% endif %}"><a href="/settings/entities" style="color:inherit;text-decoration:none;">Entities</a></div>
                <div class="nav-subitem{% if active_page == 'groups' %} active{% endif %}"><a href="/groups" style="color:inherit;text-decoration:none;">Groups</a></div>
                <div class="nav-subitem{% if active_page == 'org_chart' %} active{% endif %}"><a href="#">Org chart and structure</a></div>
                <div class="nav-subitem{% if active_page == 'organization_details' %} active{% endif %}"><a href="/settings" style="color:inherit;text-decoration:none;">Organization details</a></div>
            </div>
            <div class="nav-item expandable" data-section="security">
                <div class="nav-item-content">
                    <div class="nav-icon icon-security"></div>
                    <span>Security</span>
                    <span class="dropdown-arrow">
                        <img class="arrow-down" src="/static/images/angle-small-down.png" alt="Expand">
                        <img class="arrow-up" src="/static/images/angle-small-up.png" alt="Collapse">
                    </span>
                </div>
            </div>
            <div class="nav-subitems" data-parent="security">
                <div class="nav-subitem">Access control</div>
                <div class="nav-subitem">Authentication</div>
            </div>
        </div>
        <!-- Payroll section -->
        <div class="nav-section">
            <div class="section-title">Payroll</div>
            <div class="nav-item" data-section="expenses">
                <div class="nav-item-content">
                    <div class="nav-icon icon-dollar"></div>
                    <span>Expenses & adjustments</span>
                </div>
            </div>
        </div>
        <!-- Human Resources section -->
        <div class="nav-section">
            <div class="section-title">Human Resources</div>
            <div class="nav-item expandable" data-section="hr-settings">
                <div class="nav-item-content">
                    <div class="nav-icon icon-people"></div>
                    <span>Settings</span>
                    <span class="dropdown-arrow">
                        <img class="arrow-down" src="/static/images/angle-small-down.png" alt="Expand">
                        <img class="arrow-up" src="/static/images/angle-small-up.png" alt="Collapse">
                    </span>
                </div>
            </div>
            <div class="nav-subitems" data-parent="hr-settings">
                <div class="nav-subitem">Employee settings</div>
                <div class="nav-subitem">Time tracking</div>
            </div>
            <div class="nav-item expandable" data-section="customization">
                <div class="nav-item-content">
                    <div class="nav-icon icon-customize"></div>
                    <span>Customization</span>
                    <span class="dropdown-arrow">
                        <img class="arrow-down" src="/static/images/angle-small-down.png" alt="Expand">
                        <img class="arrow-up" src="/static/images/angle-small-up.png" alt="Collapse">
                    </span>
                </div>
            </div>
            <div class="nav-subitems" data-parent="customization">
                <div class="nav-subitem">Custom fields</div>
                <div class="nav-subitem">Templates</div>
            </div>
        </div>
    </nav>
</div>

<script>
(function() {
    // Ensure this script only runs once
    if (window.orgSidebarInitialized) return;
    window.orgSidebarInitialized = true;

    // Restore expanded state from localStorage and expand for active page
    document.addEventListener('DOMContentLoaded', function() {
        // Use requestAnimationFrame to ensure DOM is fully rendered before state changes
        requestAnimationFrame(() => {
            // First, prevent any ongoing transitions by forcing immediate state
            const allSubitems = document.querySelectorAll('.nav-subitems');
            const allExpandable = document.querySelectorAll('.nav-item.expandable');
            
            // Temporarily set all subitems to no animation
            allSubitems.forEach(item => {
                item.style.transition = 'none';
                item.style.maxHeight = '0px';
                item.classList.remove('expanded');
            });
            
            // Reset all expandable items
            allExpandable.forEach(item => {
                item.classList.remove('expanded');
            });
            
            // Force a reflow to ensure styles are applied
            document.body.offsetHeight;
            
            // Now set the correct initial state
            const expandedSections = JSON.parse(localStorage.getItem('sidebarExpandedSections') || '[]');
            expandedSections.forEach(section => {
                const navItem = document.querySelector('.nav-item.expandable[data-section="' + section + '"]');
                const subitems = document.querySelector('.nav-subitems[data-parent="' + section + '"]');
                if (navItem && subitems) {
                    navItem.classList.add('expanded');
                    subitems.classList.add('expanded');
                    subitems.style.maxHeight = '500px';
                }
            });
            
            // Always expand the parent section of the active subitem
            const activeSubitem = document.querySelector('.nav-subitem.active');
            if (activeSubitem) {
                const parentSection = activeSubitem.parentElement.getAttribute('data-parent');
                if (parentSection) {
                    const navItem = document.querySelector('.nav-item.expandable[data-section="' + parentSection + '"]');
                    const subitems = document.querySelector('.nav-subitems[data-parent="' + parentSection + '"]');
                    if (navItem && subitems) {
                        navItem.classList.add('expanded');
                        subitems.classList.add('expanded');
                        subitems.style.maxHeight = '500px';
                        
                        // Also add to localStorage if not already there
                        let expandedSections = JSON.parse(localStorage.getItem('sidebarExpandedSections') || '[]');
                        if (!expandedSections.includes(parentSection)) {
                            expandedSections.push(parentSection);
                            localStorage.setItem('sidebarExpandedSections', JSON.stringify(expandedSections));
                        }
                    }
                }
            }
            
            // Force arrow update
            updateAllArrows();
            
            // Re-enable transitions after the state is set
            requestAnimationFrame(() => {
                allSubitems.forEach(item => {
                    item.style.transition = '';
                });
            });
        });
    });

    // Handle expandable navigation items - use direct event listeners instead of delegation
    function setupExpandableItems() {
        document.querySelectorAll('.nav-item.expandable').forEach(expandableItem => {
            // Remove any existing listeners to prevent duplicates
            expandableItem.removeEventListener('click', handleExpandableClick);
            expandableItem.addEventListener('click', handleExpandableClick);
        });
    }

    function handleExpandableClick(e) {
        // Check if the click is on a link or inside a link
        if (e.target.tagName === 'A' || e.target.closest('a')) {
            return; // Allow normal link navigation
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        const expandableItem = this;
        const section = expandableItem.getAttribute('data-section');
        const subitems = document.querySelector(`[data-parent="${section}"]`);
        let expandedSections = JSON.parse(localStorage.getItem('sidebarExpandedSections') || '[]');
        
        if (subitems) {
            const isExpanded = expandableItem.classList.contains('expanded');
            
            // Toggle current item without closing others
            if (isExpanded) {
                expandableItem.classList.remove('expanded');
                subitems.classList.remove('expanded');
                // Remove from expandedSections
                const idx = expandedSections.indexOf(section);
                if (idx !== -1) expandedSections.splice(idx, 1);
            } else {
                expandableItem.classList.add('expanded');
                subitems.classList.add('expanded');
                // Add to expandedSections
                if (!expandedSections.includes(section)) expandedSections.push(section);
            }
            
            // Save to localStorage
            localStorage.setItem('sidebarExpandedSections', JSON.stringify(expandedSections));
            
            // Force arrow update
            updateAllArrows();
        }
    }

    // Handle subitem clicks - use direct event listeners
    function setupSubItems() {
        document.querySelectorAll('.nav-subitem').forEach(subitem => {
            // Remove any existing listeners to prevent duplicates
            subitem.removeEventListener('click', handleSubitemClick);
            subitem.addEventListener('click', handleSubitemClick);
        });
    }

    function handleSubitemClick(e) {
        const subitem = this;
        const link = subitem.querySelector('a');
        
        // If there's a link inside the subitem, navigate to it
        if (link && link.href && link.href !== window.location.href + '#') {
            // Allow the browser's default link behavior
            window.location.href = link.href;
            return;
        }
        
        // Only handle non-link subitems
        e.stopPropagation();
        
        // Remove active class from all subitems
        document.querySelectorAll('.nav-subitem').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to clicked subitem
        subitem.classList.add('active');
    }

    // Sidebar search functionality
    document.addEventListener('input', function(e) {
        if (!e.target.classList.contains('search-input')) return;
        
        const searchTerm = e.target.value.toLowerCase();
        const navItems = document.querySelectorAll('.nav-item, .nav-subitem');
        
        navItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            const shouldShow = text.includes(searchTerm);
            item.style.display = shouldShow ? 'flex' : 'none';
        });
    });

    // Function to update all arrow states
    function updateAllArrows() {
        document.querySelectorAll('.nav-item.expandable').forEach(item => {
            const arrowDown = item.querySelector('.arrow-down');
            const arrowUp = item.querySelector('.arrow-up');
            if (item.classList.contains('expanded')) {
                if (arrowDown) arrowDown.style.display = 'none';
                if (arrowUp) arrowUp.style.display = 'inline';
            } else {
                if (arrowDown) arrowDown.style.display = 'inline';
                if (arrowUp) arrowUp.style.display = 'none';
            }
        });
    }

    // Initialize event listeners when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setupExpandableItems();
            setupSubItems();
            updateAllArrows();
        });
    } else {
        setupExpandableItems();
        setupSubItems();
        updateAllArrows();
    }
})();
</script> 