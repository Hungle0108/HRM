{% extends "base.html" %}

{% block title %}Complete Your Profile - HR Management System{% endblock %}

{% set hide_navbar = true %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
<style>
    :root {
        --primary-color: #000000;
        --primary-hover: #333333;
        --background-color: #f8f9fa;
        --text-color: #1f2937;
        --border-color: #e5e7eb;
    }

    * {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    .profile-container {
        max-width: 600px;
        margin: 4rem auto;
        padding: 2rem;
        text-align: center;
    }

    .welcome-icon {
        width: 120px;
        height: 120px;
        margin: 0 auto 2rem;
        background: #f5f5f5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .welcome-icon img {
        width: 60px;
        height: 60px;
        object-fit: contain;
        transition: all 0.2s;
    }

    .welcome-title {
        font-size: 2.25rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-color);
        letter-spacing: -0.025em;
    }

    .welcome-subtitle {
        color: #4b5563;
        margin-bottom: 3rem;
        font-size: 1.1rem;
        font-weight: 450;
    }

    .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
    }

    .form-label {
        display: block;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        letter-spacing: -0.01em;
    }

    .form-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 1.5px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 450;
        transition: all 0.2s;
        background: white;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .form-input::placeholder {
        color: #9ca3af;
        font-weight: 450;
    }

    .error-text {
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .required {
        color: #dc2626;
    }

    .date-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        border: 1.5px solid var(--border-color);
        border-radius: 0.5rem;
        background: white;
        transition: all 0.2s;
    }

    .date-input-wrapper:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .form-input.date-input {
        border: none;
        padding: 0.875rem 1rem;
        padding-right: 40px;
        box-shadow: none;
        flex: 1;
        background: transparent;
        cursor: default;
    }

    .form-input.date-input:focus {
        border: none;
        box-shadow: none;
        outline: none;
    }

    .calendar-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        transition: all 0.2s;
        z-index: 1;
    }

    .calendar-icon:hover {
        opacity: 0.8;
        transform: translateY(-50%) scale(1.05);
    }

    .calendar-icon img {
        width: 20px;
        height: 20px;
        object-fit: contain;
        transition: all 0.2s;
    }

    .dropdown-wrapper {
        position: relative;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
    }

    .dropdown-menu.show {
        display: block;
    }

    .dropdown-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        color: var(--text-color);
    }

    .dropdown-item:hover {
        background: #f3f4f6;
    }

    .phone-input-group {
        display: flex;
        gap: 0.5rem;
    }

    .dial-code {
        width: 80px;
        flex-shrink: 0;
    }

    .phone-number {
        flex: 1;
    }

    .btn-continue {
        width: 100%;
        padding: 0.875rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        letter-spacing: -0.01em;
    }

    .btn-continue:hover {
        background: var(--primary-hover);
    }

    .btn-back {
        width: 100%;
        padding: 0.875rem;
        background: white;
        color: var(--primary-color);
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        letter-spacing: -0.01em;
        margin-bottom: 1rem;
    }

    .btn-back:hover {
        border-color: var(--primary-color);
        background: var(--background-color);
    }

    .next-step {
        text-align: right;
        margin-top: 1rem;
        font-size: 0.95rem;
        font-weight: 500;
        color: #4b5563;
    }

    /* Custom Flatpickr Styles */
    .flatpickr-calendar {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        width: 360px !important;
        padding: 20px;
        border: none !important;
    }

    /* Header section */
    .flatpickr-months {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 0 5px;
    }

    .flatpickr-month {
        display: flex;
        align-items: center;
        width: auto;
    }

    .flatpickr-current-month {
        display: flex;
        align-items: center;
        font-size: 18px;
        font-weight: 500;
        padding: 0;
        position: relative;
        /* Prevent the container from changing size */
        min-width: 220px; /* Increased from 180px to accommodate longer month names like December */
        justify-content: flex-start;
    }

    .flatpickr-current-month .numInputWrapper {
        display: inline-block;
        width: 60px;
        position: relative;
        vertical-align: baseline;
    }

    /* Month and Year display */
    .cur-month {
        margin-right: 4px;
        pointer-events: none;
        cursor: default;
        min-width: 100px; /* Ensure minimum space for month names */
        white-space: nowrap; /* Prevent text wrapping */
        overflow: visible; /* Ensure text isn't clipped */
    }

    .cur-year {
        pointer-events: none;
        cursor: default;
        display: inline-block;
        width: 50px; /* Reduced from 60px to save space */
        text-align: left;
        font-variant-numeric: tabular-nums;
        letter-spacing: 0;
    }

    /* HIGHEST SPECIFICITY OVERRIDES FOR MONTH DISPLAY */
    .flatpickr-calendar .flatpickr-months .flatpickr-current-month,
    .flatpickr-calendar .flatpickr-current-month {
        min-width: 250px !important; /* Increased even more to ensure space */
        width: auto !important; /* Allow it to expand as needed */
        max-width: none !important; /* Remove any max-width restrictions */
        flex-shrink: 0 !important; /* Prevent shrinking */
        overflow: visible !important; /* Ensure text isn't clipped */
    }

    .flatpickr-calendar .flatpickr-months .flatpickr-current-month .cur-month,
    .flatpickr-calendar .flatpickr-current-month .cur-month,
    .flatpickr-calendar .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-calendar .cur-month {
        min-width: 120px !important; /* Ensure enough space for "December" */
        width: auto !important; /* Allow auto-sizing */
        max-width: none !important; /* Remove restrictions */
        white-space: nowrap !important; /* Never wrap text */
        overflow: visible !important; /* Never clip text */
        text-overflow: clip !important; /* Don't add ellipsis */
        margin-right: 8px !important; /* Add more spacing */
        flex-shrink: 0 !important; /* Prevent shrinking */
        display: inline-block !important; /* Ensure proper display */
    }

    .flatpickr-calendar .flatpickr-months .flatpickr-current-month .cur-year,
    .flatpickr-calendar .flatpickr-current-month .cur-year,
    .flatpickr-calendar .cur-year,
    .flatpickr-calendar .numInput.cur-year {
        width: 50px !important; /* Fixed width for year */
        min-width: 50px !important; /* Minimum width */
        max-width: 50px !important; /* Maximum width */
        margin-left: 4px !important; /* Add spacing */
        flex-shrink: 0 !important; /* Prevent shrinking */
    }

    /* Ensure the header section has enough space */
    .flatpickr-calendar .flatpickr-months {
        padding: 0 3px !important; /* Reduce side padding to give more internal space */
        min-height: 40px !important; /* Ensure adequate height */
        width: 100% !important; /* Full width */
        overflow: visible !important; /* Allow content to overflow if needed */
    }

    /* Reduce year dropdown button margin to save space */
    .flatpickr-calendar .year-dropdown-btn {
        margin-left: 1px !important; /* Minimal margin */
        flex-shrink: 0 !important; /* Don't shrink */
    }

    /* Custom year dropdown button */
    .year-dropdown-btn {
        margin-left: 2px; /* Reduced from 4px to save space */
        padding: 2px 4px;
        background: none;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
        transition: background-color 0.2s;
        font-size: 12px;
        color: #666;
    }

    .year-dropdown-btn:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }

    .year-dropdown-btn.active {
        background-color: rgba(0, 0, 0, 0.15);
    }

    /* Year selection grid - now inside the calendar */
    .year-grid {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        border-radius: 8px;
        z-index: 1000;
        padding: 20px;
        display: none;
        overflow-y: auto;
        overflow-x: hidden; /* Prevent horizontal scrollbar */
        box-sizing: border-box; /* Include padding in size calculation */
        contain: layout style; /* Contain layout to prevent overflow */
    }

    .year-grid.show {
        display: block;
    }

    .year-grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px; /* Reduced gap for more compact layout */
        width: 100%; /* Ensure it fits within container */
        box-sizing: border-box; /* Include padding in width calculation */
    }

    .year-option {
        padding: 10px; /* Reduced padding */
        text-align: center;
        cursor: pointer;
        border-radius: 6px; /* Slightly reduced border radius */
        font-size: 13px; /* Slightly smaller font */
        font-weight: 500;
        transition: all 0.2s;
        border: 1px solid transparent;
        background: #f8f9fa;
        box-sizing: border-box; /* Include padding and border in width */
        min-width: 0; /* Allow items to shrink if needed */
    }

    .year-option:hover {
        background-color: #e9ecef;
        border-color: #d1d5db;
        transform: translateY(-1px);
    }

    .year-option.selected {
        background-color: #000;
        color: white;
        border-color: #000;
    }

    .year-option.disabled {
        opacity: 0.3;
        cursor: not-allowed;
        background-color: #f9f9f9;
        color: #ccc;
    }

    .year-option.disabled:hover {
        background-color: #f9f9f9;
        border-color: transparent;
        transform: none;
    }

    /* Hide calendar content when year grid is shown */
    .flatpickr-calendar.year-mode .flatpickr-days,
    .flatpickr-calendar.year-mode .flatpickr-weekdays {
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
        /* Keep display: block to preserve space */
    }

    /* Hide month navigation buttons in year mode */
    .flatpickr-calendar.year-mode .flatpickr-prev-month,
    .flatpickr-calendar.year-mode .flatpickr-next-month {
        display: none !important;
        visibility: hidden !important;
    }

    /* Force hide with maximum specificity - this will override any other styles */
    .flatpickr-calendar.year-mode .flatpickr-months .flatpickr-prev-month,
    .flatpickr-calendar.year-mode .flatpickr-months .flatpickr-next-month,
    .flatpickr-calendar.year-mode .flatpickr-prev-month,
    .flatpickr-calendar.year-mode .flatpickr-next-month {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
        position: absolute !important;
        left: -9999px !important;
        width: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
    }

    /* Maintain original calendar size in year mode */
    .flatpickr-calendar.year-mode {
        min-height: 400px !important; /* Ensure adequate height for year grid */
        height: 400px !important; /* Fixed height for consistent display */
        max-height: 400px !important; /* Force exact height */
        width: 360px !important; /* Fixed square dimensions */
        max-width: 360px !important; /* Force exact width */
        overflow: visible !important; /* Allow popup to float freely */
        position: absolute !important; /* Allow floating outside container */
        resize: none !important; /* Prevent any resizing */
        z-index: 9999 !important; /* Ensure it appears above everything */
        box-sizing: border-box !important; /* Include padding in dimensions */
    }

    /* Remove auto-sizing override to allow natural floating */
    .flatpickr-calendar.year-mode.inline,
    .flatpickr-calendar.year-mode.static {
        position: absolute !important; /* Ensure it can float */
        z-index: 9999 !important; /* Ensure it appears above everything */
    }

    .flatpickr-calendar.year-mode .year-grid {
        display: block !important;
        position: absolute !important;
        top: 60px !important; /* Start below the header */
        left: 15px !important; /* Margins */
        right: 15px !important; /* Margins */
        bottom: 15px !important; /* Bottom margin */
        width: calc(100% - 30px) !important; /* Fixed width calculation */
        height: 325px !important; /* Fixed height instead of percentage */
        max-width: 330px !important; /* Ensure containment */
        max-height: 325px !important; /* Match the fixed height */
        overflow-x: hidden !important; /* Prevent horizontal scrollbar */
        overflow-y: auto !important; /* Allow vertical scrolling only */
        box-sizing: border-box !important; /* Include padding in size calculation */
    }

    /* Hide default year navigation arrows */
    .flatpickr-current-month .numInputWrapper::after,
    .flatpickr-current-month .numInputWrapper::before {
        display: none !important;
    }

    .flatpickr-current-month .arrowUp,
    .flatpickr-current-month .arrowDown {
        display: none !important;
    }

    /* Navigation arrows container */
    .flatpickr-months {
        position: relative;
    }

    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
        position: static;
        height: 32px;
        width: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 8px;
    }

    .flatpickr-months .flatpickr-prev-month svg,
    .flatpickr-months .flatpickr-next-month svg {
        width: 20px;
        height: 20px;
        fill: none !important;
        stroke: #000;
        stroke-width: 2;
    }

    /* Group the navigation buttons together */
    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
        order: 2;
    }

    .flatpickr-current-month {
        order: 1;
    }

    /* Hide any remaining toggle indicators */
    .numInputWrapper::after,
    .flatpickr-current-month .cur-month::after,
    .flatpickr-current-month .flatpickr-monthDropdown-months::after,
    .flatpickr-current-month select::after,
    .flatpickr-current-month select::-ms-expand {
        display: none !important;
    }

    .flatpickr-current-month select,
    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .numInput.cur-year {
        background: transparent !important;
        border: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
        pointer-events: none !important;
        cursor: default !important;
        padding: 0;
        width: 60px !important;
        text-align: left !important;
        font-variant-numeric: tabular-nums !important;
        letter-spacing: 0 !important;
        margin: 0 !important;
        display: inline-block !important;
    }

    /* Weekday headers */
    .flatpickr-weekdays {
        margin: 0 0 15px 0;
        padding: 15px 0 0 0;
        display: flex;
        justify-content: space-between;
        width: 100%;
        border-top: 1px solid #eee;
    }

    .flatpickr-weekdaycontainer {
        display: flex;
        justify-content: space-between;
        width: 100%;
        padding: 0 2px;
    }

    .flatpickr-weekday {
        font-size: 14px;
        font-weight: 500;
        color: #000;
        opacity: 0.7;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px 0;
        margin: 0;
        min-width: 40px;
    }

    /* Calendar days */
    .flatpickr-day {
        width: 40px;
        height: 40px;
        line-height: 40px;
        font-size: 14px;
        border-radius: 50%;
        margin: 2px 0;
        color: #000;
        opacity: 0.7;
        border: none;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        flex: 0 0 40px;
    }

    .flatpickr-day:hover {
        background: #e2e2e2;
        opacity: 1;
    }

    .flatpickr-day.selected {
        background: #000;
        color: #fff;
        opacity: 1;
    }

    .flatpickr-day.prevMonthDay,
    .flatpickr-day.nextMonthDay {
        visibility: hidden;
        opacity: 0;
        pointer-events: none;
    }

    .flatpickr-days {
        width: 100% !important;
        padding: 0;
    }

    .dayContainer {
        width: 100%;
        min-width: 100%;
        max-width: 100%;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        padding: 0 2px;
        outline: 0;
        text-align: left;
    }

    /* Animations */
    .flatpickr-calendar.animate.open {
        animation: fpFadeInDown 200ms cubic-bezier(0.23, 1, 0.32, 1);
    }

    @keyframes fpFadeInDown {
        from { opacity: 0; transform: translate3d(0, -20px, 0); }
        to { opacity: 1; transform: translate3d(0, 0, 0); }
    }

    /* Ensure consistent spacing for week rows */
    .flatpickr-weeks {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        width: 100%;
    }

    /* Flatpickr custom styling for disabled future navigation */
    .flatpickr-calendar .flatpickr-next-month.disabled,
    .flatpickr-calendar .flatpickr-prev-month.disabled {
        opacity: 0.3 !important;
        cursor: not-allowed !important;
        pointer-events: none !important;
        filter: grayscale(100%) !important;
        /* Keep the button visible but clearly disabled */
        display: flex !important;
        visibility: visible !important;
    }

    .flatpickr-calendar .flatpickr-next-month.disabled:hover,
    .flatpickr-calendar .flatpickr-prev-month.disabled:hover {
        background: transparent !important;
        opacity: 0.3 !important;
    }

    .flatpickr-calendar .flatpickr-next-month.disabled svg,
    .flatpickr-calendar .flatpickr-prev-month.disabled svg {
        color: #ccc !important;
        opacity: 0.5 !important;
    }

    /* Remove the overlay styling since we want the button to remain visible */
    .flatpickr-calendar .flatpickr-next-month.disabled::after,
    .flatpickr-calendar .flatpickr-prev-month.disabled::after {
        display: none !important;
    }

    /* Ensure enabled buttons are fully functional */
    .flatpickr-calendar .flatpickr-next-month:not(.disabled),
    .flatpickr-calendar .flatpickr-prev-month:not(.disabled) {
        opacity: 1 !important;
        cursor: pointer !important;
        pointer-events: auto !important;
        filter: none !important;
    }

    .flatpickr-calendar .flatpickr-next-month:not(.disabled):hover,
    .flatpickr-calendar .flatpickr-prev-month:not(.disabled):hover {
        background: rgba(0, 0, 0, 0.1) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="welcome-icon">
        <img src="{{ url_for('static', filename='images/user.png') }}" alt="User">
    </div>
    
    <h1 class="welcome-title" id="welcomeTitle"></h1>
    <p class="welcome-subtitle" id="welcomeSubtitle"></p>

    <form id="completeProfileForm">
        <div class="form-group">
            <label class="form-label" id="citizenshipLabel"><span class="required">*</span></label>
            <div class="dropdown-wrapper">
                <input type="text" class="form-input" id="citizenshipInput" value="{{ profile_data.citizenship or '' }}" required>
                <div class="dropdown-menu" id="citizenshipDropdown"></div>
            </div>
            <div class="error-text" id="citizenshipError"></div>
        </div>

        <div class="form-group">
            <label class="form-label" id="dateLabel"><span class="required">*</span></label>
            <div class="date-input-wrapper">
                <input type="text" class="form-input date-input" id="dateOfBirth" value="{{ profile_data.date_of_birth or '' }}" readonly>
                <button type="button" class="calendar-icon" id="calendarToggle">
                    <img src="{{ url_for('static', filename='images/calendar-lines.png') }}" alt="Calendar">
                </button>
            </div>
            <div class="error-text" id="dateError"></div>
        </div>

        <div class="form-group">
            <label class="form-label" id="phoneLabel"><span class="required">*</span></label>
            <div class="phone-input-group">
                <input type="text" class="form-input dial-code" value="+84" readonly>
                <input type="tel" class="form-input phone-number" id="phoneNumber" value="{{ profile_data.phone_number or '' }}" required>
            </div>
            <div class="error-text" id="phoneError"></div>
        </div>

        <button type="submit" class="btn-continue" id="continueButton"></button>
        <div class="next-step" id="nextStep"></div>
    </form>
</div>

<script src="{{ url_for('static', filename='js/translations.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script>
    const countries = [
    'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria', 'Azerbaijan',
    'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan', 'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi',
    'Cabo Verde', 'Cambodia', 'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czech Republic',
    'Denmark', 'Djibouti', 'Dominica', 'Dominican Republic',
    'Ecuador', 'Egypt', 'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini', 'Ethiopia',
    'Fiji', 'Finland', 'France',
    'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau', 'Guyana',
    'Haiti', 'Honduras', 'Hungary',
    'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Italy', 'Ivory Coast',
    'Jamaica', 'Japan', 'Jordan',
    'Kazakhstan', 'Kenya', 'Kiribati', 'Kuwait', 'Kyrgyzstan',
    'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania', 'Luxembourg',
    'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta', 'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar',
    'Namibia', 'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Korea', 'North Macedonia', 'Norway',
    'Oman',
    'Pakistan', 'Palau', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal',
    'Qatar',
    'Romania', 'Russia', 'Rwanda',
    'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino', 'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia', 'South Africa', 'South Korea', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria',
    'Taiwan', 'Tajikistan', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu',
    'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan',
    'Vanuatu', 'Vatican City', 'Venezuela', 'Vietnam',
    'Yemen',
    'Zambia', 'Zimbabwe'
    ];

document.addEventListener('DOMContentLoaded', function() {
    // Get saved language preference
    const currentLanguage = localStorage.getItem('preferredLanguage') || 'en';
    const trans = translations[currentLanguage].completeProfile;

    // Update text content
    document.getElementById('welcomeTitle').textContent = trans.title.replace('{name}', '{{ user.first_name }}');
    document.getElementById('welcomeSubtitle').textContent = trans.subtitle;
    document.getElementById('citizenshipLabel').textContent = trans.citizenship;
    document.getElementById('dateLabel').textContent = trans.dateOfBirth;
    document.getElementById('phoneLabel').textContent = trans.phoneNumber;
    document.getElementById('continueButton').textContent = trans.continue;
    document.getElementById('nextStep').textContent = trans.nextStep;

    // Update placeholders
    document.getElementById('citizenshipInput').placeholder = trans.citizenshipPlaceholder;
    document.getElementById('dateOfBirth').placeholder = trans.dateOfBirthPlaceholder;
    document.getElementById('phoneNumber').placeholder = trans.phoneNumberPlaceholder;

    // Get form elements once
    const completeProfileForm = document.getElementById('completeProfileForm');
    const citizenshipInput = document.getElementById('citizenshipInput');
    const dateInput = document.getElementById('dateOfBirth');
    const phoneInput = document.getElementById('phoneNumber');
    let selectedCountry = '';

    // Store form data in localStorage when it changes
    function storeFormData() {
        const formData = {
            citizenship: citizenshipInput.value,
            dateOfBirth: dateInput.value,
            phoneNumber: phoneInput.value
        };
        localStorage.setItem('completeProfileFormData', JSON.stringify(formData));
    }

    // Load form data from localStorage
    function loadFormData() {
        const storedData = localStorage.getItem('completeProfileFormData');
        if (storedData) {
            const formData = JSON.parse(storedData);
            citizenshipInput.value = formData.citizenship || '';
            dateInput.value = formData.dateOfBirth || '';
            phoneInput.value = formData.phoneNumber || '';
            selectedCountry = formData.citizenship || '';
        }
    }

    // Load stored data when page loads
    loadFormData();

    // Store data when inputs change
    citizenshipInput.addEventListener('input', storeFormData);
    dateInput.addEventListener('change', storeFormData);
    phoneInput.addEventListener('input', storeFormData);

    // Citizenship dropdown functionality
    const citizenshipDropdown = document.getElementById('citizenshipDropdown');

    function filterCountries(searchText) {
        return countries.filter(country => 
            country.toLowerCase().includes(searchText.toLowerCase())
        );
    }

    function updateDropdown(filteredCountries) {
        citizenshipDropdown.innerHTML = '';
        
        if (filteredCountries.length > 0) {
            filteredCountries.forEach(country => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                if (country === selectedCountry) {
                    div.classList.add('selected');
                }
                div.textContent = country;
                div.addEventListener('click', () => {
                    citizenshipInput.value = country;
                    selectedCountry = country;
                    citizenshipDropdown.classList.remove('show');
                    document.getElementById('citizenshipError').textContent = '';
                    storeFormData(); // Store data when selecting from dropdown
                });
                citizenshipDropdown.appendChild(div);
            });
            citizenshipDropdown.classList.add('show');
        } else {
            citizenshipDropdown.classList.remove('show');
        }
    }

    if (citizenshipInput) {
        citizenshipInput.addEventListener('input', (e) => {
            const searchText = e.target.value;
            const filteredCountries = filterCountries(searchText);
            updateDropdown(filteredCountries);
        });

        citizenshipInput.addEventListener('focus', () => {
            if (citizenshipInput.value) {
                const filteredCountries = filterCountries(citizenshipInput.value);
                updateDropdown(filteredCountries);
            } else {
                updateDropdown(countries);
            }
        });
    }

    document.addEventListener('click', (e) => {
        if (citizenshipInput && citizenshipDropdown && e.target &&
            !citizenshipInput.contains(e.target) && !citizenshipDropdown.contains(e.target)) {
            citizenshipDropdown.classList.remove('show');
        }
    });

    // Date picker functionality
    const calendarToggle = document.getElementById('calendarToggle');

    if (dateInput && calendarToggle) {
        const fp = flatpickr(dateInput, {
            dateFormat: "Y-m-d",
            maxDate: new Date(2025, 5, 10), // June 10, 2025 (month is 0-indexed) - for date selection only
            minDate: "1900-01-01",
            defaultDate: null,
            clickOpens: true,
            allowInput: false,
            static: false, // Allow popup to float freely outside container
            showMonths: 1,
            fixedHeight: false, // Disable to prevent interference with year mode height
            showOutsideDays: false,
            disableMobile: true, // Ensure our custom navigation works
            onChange: function(selectedDates, dateStr) {
                storeFormData(); // Store data when date changes
            },
            onMonthChange: function(selectedDates, dateStr, instance) {
                // Check and disable navigation buttons after month change
                setTimeout(() => {
                    checkAndDisableNavigation(instance);
                    setupYearDropdown(instance); // Re-setup year dropdown after month change
                }, 10);
            },
            onYearChange: function(selectedDates, dateStr, instance) {
                // Check and disable navigation buttons after year change
                setTimeout(() => {
                    checkAndDisableNavigation(instance);
                    setupYearDropdown(instance); // Re-setup year dropdown after year change
                }, 10);
            },
            onOpen: function(selectedDates, dateStr, instance) {
                // Check and disable navigation buttons when calendar opens
                setTimeout(() => {
                    checkAndDisableNavigation(instance);
                    setupYearDropdown(instance); // Setup year dropdown when calendar opens
                }, 10);
            },
            onReady: function(selectedDates, dateStr, instance) {
                // Check and disable navigation buttons when calendar is ready
                setTimeout(() => {
                    checkAndDisableNavigation(instance);
                    setupYearDropdown(instance); // Setup year dropdown when calendar is ready
                }, 10);
            }
        });

        // Initial check after flatpickr is created
        setTimeout(() => {
            checkAndDisableNavigation(fp);
            setupYearDropdown(fp); // Setup year dropdown initially
        }, 50);

        // Function to check and disable future navigation
        function checkAndDisableNavigation(instance) {
            if (!instance || !instance.calendarContainer) return;
            
            const calendar = instance.calendarContainer;
            const nextButton = calendar.querySelector('.flatpickr-next-month');
            const prevButton = calendar.querySelector('.flatpickr-prev-month');
            
            if (nextButton && prevButton) {
                const currentMonth = instance.currentMonth;
                const currentYear = instance.currentYear;
                
                // Current date is June 10, 2025
                const today = new Date(2025, 5, 10); // Month is 0-indexed, so 5 = June
                
                // Calculate the first day of the next month that would be shown
                const nextMonth = new Date(currentYear, currentMonth + 1, 1);
                
                // Calculate the first day of the previous month that would be shown
                const prevMonth = new Date(currentYear, currentMonth - 1, 1);
                
                // Debug logging
                console.log('Current calendar view:', currentYear, currentMonth + 1); // +1 for human readable month
                console.log('Next month would be:', nextMonth);
                console.log('Today is:', today);
                console.log('Is next month in future?', nextMonth > today);
                
                // Always keep the button visible, but disable functionality and obscure appearance for future months
                if (nextMonth > today) {
                    console.log('Disabling next button (making it obscured but visible)');
                    nextButton.classList.add('disabled');
                    // Make button visually obscured but still visible
                    nextButton.style.opacity = '0.3';
                    nextButton.style.cursor = 'not-allowed';
                    nextButton.style.pointerEvents = 'none'; // Prevent clicking
                    // Add a subtle filter to make it more obviously disabled
                    nextButton.style.filter = 'grayscale(100%)';
                } else {
                    console.log('Enabling next button (fully functional and visible)');
                    nextButton.classList.remove('disabled');
                    // Make button fully visible and functional
                    nextButton.style.opacity = '1';
                    nextButton.style.cursor = 'pointer';
                    nextButton.style.pointerEvents = 'auto'; // Allow clicking
                    nextButton.style.filter = 'none'; // Remove any filters
                }
                
                // Handle previous button (should work until we reach the minimum date: January 1900)
                const minDate = new Date(1900, 0, 1);
                if (prevMonth < minDate) {
                    prevButton.classList.add('disabled');
                    prevButton.style.opacity = '0.3';
                    prevButton.style.cursor = 'not-allowed';
                    prevButton.style.pointerEvents = 'none';
                    prevButton.style.filter = 'grayscale(100%)';
                } else {
                    prevButton.classList.remove('disabled');
                    prevButton.style.opacity = '1';
                    prevButton.style.cursor = 'pointer';
                    prevButton.style.pointerEvents = 'auto';
                    prevButton.style.filter = 'none';
                }
            }
        }

        // Override the default click handlers to respect our disabled state
        const originalNextMonth = fp.nextMonth;
        const originalPrevMonth = fp.prevMonth;
        
        fp.nextMonth = function() {
            if (!fp.calendarContainer) return;
            
            const calendar = fp.calendarContainer;
            const nextButton = calendar.querySelector('.flatpickr-next-month');
            
            if (nextButton && !nextButton.classList.contains('disabled')) {
                originalNextMonth.call(fp);
                setTimeout(() => {
                    checkAndDisableNavigation(fp);
                }, 10);
            }
        };
        
        fp.prevMonth = function() {
            if (!fp.calendarContainer) return;
            
            const calendar = fp.calendarContainer;
            const prevButton = calendar.querySelector('.flatpickr-prev-month');
            
            if (prevButton && !prevButton.classList.contains('disabled')) {
                originalPrevMonth.call(fp);
                setTimeout(() => {
                    checkAndDisableNavigation(fp);
                }, 10);
            }
        };

        calendarToggle.addEventListener('click', (e) => {
            e.preventDefault();
            if (fp) {
                fp.toggle();
            }
        });
    }

    // Phone number validation
    if (phoneInput) {
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
            
            // Remove initial zero if present
            if (value.startsWith('0')) {
                value = value.substring(1);
            }
            
            // Limit to 9 digits (since we removed the initial zero)
            e.target.value = value.slice(0, 9);
            storeFormData(); // Store data when phone number changes
        });
    }

    // Form submission
    if (completeProfileForm) {
        completeProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Reset error messages
            document.querySelectorAll('.error-text').forEach(el => el.textContent = '');
            
            // Validate inputs
            let isValid = true;
            
            if (!citizenshipInput.value) {
                document.getElementById('citizenshipError').textContent = trans.errorCitizenship;
                isValid = false;
            }
            
            if (!dateInput.value) {
                document.getElementById('dateError').textContent = trans.errorDate;
                isValid = false;
            }
            
            if (!phoneInput.value || phoneInput.value.length !== 9) {
                document.getElementById('phoneError').textContent = trans.errorPhone;
                isValid = false;
            }
            
            if (isValid) {
                try {
                    const response = await fetch('/api/complete-profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            citizenship: citizenshipInput.value,
                            dateOfBirth: dateInput.value,
                            phoneNumber: phoneInput.value,
                        }),
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Clear stored form data before redirecting
                        localStorage.removeItem('completeProfileFormData');
                        window.location.href = '/organization-setup';
                    } else {
                        throw new Error(data.error || 'Failed to complete profile');
                    }
                } catch (error) {
                    alert(error.message);
                }
            }
        });
    }

    // Function to setup year dropdown functionality
    function setupYearDropdown(instance) {
        if (!instance || !instance.calendarContainer) return;
        
        const calendar = instance.calendarContainer;
        const currentMonthContainer = calendar.querySelector('.flatpickr-current-month');
        
        if (!currentMonthContainer) return;
        
        // Remove existing year dropdown if it exists
        const existingDropdownBtn = currentMonthContainer.querySelector('.year-dropdown-btn');
        const existingYearGrid = calendar.querySelector('.year-grid');
        if (existingDropdownBtn) existingDropdownBtn.remove();
        if (existingYearGrid) existingYearGrid.remove();
        
        // Create year dropdown button
        const yearDropdownBtn = document.createElement('button');
        yearDropdownBtn.className = 'year-dropdown-btn';
        yearDropdownBtn.innerHTML = '▼'; // Down arrow
        yearDropdownBtn.type = 'button';
        
        // Create year grid container
        const yearGrid = document.createElement('div');
        yearGrid.className = 'year-grid';
        
        const yearGridContainer = document.createElement('div');
        yearGridContainer.className = 'year-grid-container';
        
        // Generate years from 1900 to 2025
        const currentYear = instance.currentYear;
        const maxYear = 2025;
        const minYear = 1900;
        
        for (let year = maxYear; year >= minYear; year--) {
            const yearOption = document.createElement('div');
            yearOption.className = 'year-option';
            yearOption.textContent = year;
            
            if (year === currentYear) {
                yearOption.classList.add('selected');
            }
            
            // Disable future years beyond 2025
            if (year > maxYear) {
                yearOption.classList.add('disabled');
            } else {
                yearOption.addEventListener('click', () => {
                    instance.changeYear(year);
                    // Exit year mode and return to calendar
                    calendar.classList.remove('year-mode');
                    yearDropdownBtn.classList.remove('active');
                    yearDropdownBtn.innerHTML = '▼'; // Reset to down arrow
                });
            }
            
            yearGridContainer.appendChild(yearOption);
        }
        
        yearGrid.appendChild(yearGridContainer);
        
        // Add click handler for dropdown button
        yearDropdownBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const isYearMode = calendar.classList.contains('year-mode');
            
            if (isYearMode) {
                // Exit year mode, show calendar
                calendar.classList.remove('year-mode');
                yearDropdownBtn.classList.remove('active');
                yearDropdownBtn.innerHTML = '▼'; // Down arrow
            } else {
                // Enter year mode, hide calendar days and show year grid
                calendar.classList.add('year-mode');
                yearDropdownBtn.classList.add('active');
                yearDropdownBtn.innerHTML = '▲'; // Up arrow
                
                // Update selected year in grid
                const yearOptions = yearGrid.querySelectorAll('.year-option');
                yearOptions.forEach(option => {
                    option.classList.remove('selected');
                    if (parseInt(option.textContent) === instance.currentYear) {
                        option.classList.add('selected');
                    }
                });
                
                // Scroll to selected year
                setTimeout(() => {
                    const selectedOption = yearGrid.querySelector('.year-option.selected');
                    if (selectedOption) {
                        selectedOption.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                }, 10);
            }
        });
        
        // Close year mode when clicking outside the calendar (handled by flatpickr)
        // But we don't want to close when clicking inside the year grid
        
        // Append dropdown button after the year
        currentMonthContainer.appendChild(yearDropdownBtn);
        
        // Insert year grid as the last child of calendar container
        calendar.appendChild(yearGrid);
    }
});

</script>
{% endblock %} 