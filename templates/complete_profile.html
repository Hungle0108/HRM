{% extends "base.html" %}

{% block title %}Complete Your Profile - HR Management System{% endblock %}

{% set hide_navbar = true %}

{% block styles %}
<style>
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --background-color: #f8f9fa;
        --text-color: #1f2937;
        --border-color: #e5e7eb;
    }

    .profile-container {
        max-width: 600px;
        margin: 4rem auto;
        padding: 2rem;
        text-align: center;
    }

    .welcome-icon {
        width: 120px;
        height: 120px;
        margin: 0 auto 2rem;
        background: #e0e7ff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .welcome-icon svg {
        width: 60px;
        height: 60px;
        color: var(--primary-color);
    }

    .welcome-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-color);
    }

    .welcome-subtitle {
        color: #4b5563;
        margin-bottom: 3rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 1rem;
        transition: all 0.2s;
        background: white;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .error-text {
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .required {
        color: #dc2626;
    }

    .date-input-wrapper {
        position: relative;
    }

    .date-input-wrapper .calendar-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #6b7280;
    }

    .dropdown-wrapper {
        position: relative;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
    }

    .dropdown-menu.show {
        display: block;
    }

    .dropdown-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        color: var(--text-color);
    }

    .dropdown-item:hover {
        background: #f3f4f6;
    }

    .phone-input-group {
        display: flex;
        gap: 0.5rem;
    }

    .dial-code {
        width: 80px;
        flex-shrink: 0;
    }

    .phone-number {
        flex: 1;
    }

    .btn-continue {
        width: 100%;
        padding: 0.75rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 0.375rem;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-continue:hover {
        background: var(--primary-hover);
    }

    .next-step {
        text-align: right;
        margin-top: 1rem;
        font-size: 0.875rem;
        color: #4b5563;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="welcome-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
        </svg>
    </div>
    
    <h1 class="welcome-title">Welcome, {{ user.first_name }}!</h1>
    <p class="welcome-subtitle">We just need a few details to complete your profile</p>

    <form id="completeProfileForm">
        <div class="form-group">
            <label class="form-label">Citizenship <span class="required">*</span></label>
            <div class="dropdown-wrapper">
                <input type="text" class="form-input" id="citizenshipInput" placeholder="Start typing your citizenship" required>
                <div class="dropdown-menu" id="citizenshipDropdown"></div>
            </div>
            <div class="error-text" id="citizenshipError"></div>
        </div>

        <div class="form-group">
            <label class="form-label">Date of birth <span class="required">*</span></label>
            <div class="date-input-wrapper">
                <input type="text" class="form-input" id="dateOfBirth" placeholder="MM/DD/YYYY" required>
                <span class="calendar-icon" id="calendarToggle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </span>
            </div>
            <div class="error-text" id="dateError"></div>
        </div>

        <div class="form-group">
            <label class="form-label">Phone number <span class="required">*</span></label>
            <div class="phone-input-group">
                <input type="text" class="form-input dial-code" value="+84" readonly>
                <input type="tel" class="form-input phone-number" id="phoneNumber" placeholder="Enter your phone number" required>
            </div>
            <div class="error-text" id="phoneError"></div>
        </div>

        <button type="submit" class="btn-continue">Continue</button>
        <div class="next-step">
            Next step: Your organization
        </div>
    </form>
</div>

<script>
const countries = [
    'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria', 'Azerbaijan',
    'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan', 'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi',
    'Cabo Verde', 'Cambodia', 'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czech Republic',
    'Denmark', 'Djibouti', 'Dominica', 'Dominican Republic',
    'Ecuador', 'Egypt', 'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini', 'Ethiopia',
    'Fiji', 'Finland', 'France',
    'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau', 'Guyana',
    'Haiti', 'Honduras', 'Hungary',
    'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Italy', 'Ivory Coast',
    'Jamaica', 'Japan', 'Jordan',
    'Kazakhstan', 'Kenya', 'Kiribati', 'Kuwait', 'Kyrgyzstan',
    'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania', 'Luxembourg',
    'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta', 'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar',
    'Namibia', 'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Korea', 'North Macedonia', 'Norway',
    'Oman',
    'Pakistan', 'Palau', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal',
    'Qatar',
    'Romania', 'Russia', 'Rwanda',
    'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino', 'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia', 'South Africa', 'South Korea', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria',
    'Taiwan', 'Tajikistan', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu',
    'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan',
    'Vanuatu', 'Vatican City', 'Venezuela', 'Vietnam',
    'Yemen',
    'Zambia', 'Zimbabwe'
];

document.addEventListener('DOMContentLoaded', function() {
    const citizenshipInput = document.getElementById('citizenshipInput');
    const citizenshipDropdown = document.getElementById('citizenshipDropdown');
    let selectedCountry = '';

    function filterCountries(searchText) {
        return countries.filter(country => 
            country.toLowerCase().includes(searchText.toLowerCase())
        );
    }

    function updateDropdown(filteredCountries) {
        citizenshipDropdown.innerHTML = '';
        
        if (filteredCountries.length > 0) {
            filteredCountries.forEach(country => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.textContent = country;
                div.addEventListener('click', () => {
                    citizenshipInput.value = country;
                    selectedCountry = country;
                    citizenshipDropdown.classList.remove('show');
                });
                citizenshipDropdown.appendChild(div);
            });
            citizenshipDropdown.classList.add('show');
        } else {
            citizenshipDropdown.classList.remove('show');
        }
    }

    citizenshipInput.addEventListener('input', (e) => {
        const searchText = e.target.value;
        const filteredCountries = filterCountries(searchText);
        updateDropdown(filteredCountries);
    });

    citizenshipInput.addEventListener('focus', () => {
        if (citizenshipInput.value) {
            const filteredCountries = filterCountries(citizenshipInput.value);
            updateDropdown(filteredCountries);
        }
    });

    document.addEventListener('click', (e) => {
        if (!citizenshipInput.contains(e.target) && !citizenshipDropdown.contains(e.target)) {
            citizenshipDropdown.classList.remove('show');
        }
    });
});

// Date picker functionality
const dateInput = document.getElementById('dateOfBirth');
const calendarToggle = document.getElementById('calendarToggle');

// Initialize flatpickr date picker
const datePicker = flatpickr(dateInput, {
    dateFormat: "m/d/Y",
    maxDate: new Date(),
    yearRange: [1900, new Date().getFullYear()],
    defaultDate: null,
});

calendarToggle.onclick = () => {
    datePicker.toggle();
};

// Phone number validation
const phoneInput = document.getElementById('phoneNumber');
phoneInput.addEventListener('input', (e) => {
    // Remove any non-digit characters
    let value = e.target.value.replace(/\D/g, '');
    
    // Ensure the number starts with '0' if not empty
    if (value.length > 0 && value[0] !== '0') {
        value = '0' + value;
    }
    
    // Limit to 10 digits (Vietnamese phone number format)
    value = value.slice(0, 10);
    
    e.target.value = value;
});

// Form submission
document.getElementById('completeProfileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Reset error messages
    document.querySelectorAll('.error-text').forEach(el => el.textContent = '');
    
    // Validate inputs
    let isValid = true;
    
    if (!citizenshipInput.value) {
        document.getElementById('citizenshipError').textContent = 'Please select your citizenship';
        isValid = false;
    }
    
    if (!dateInput.value) {
        document.getElementById('dateError').textContent = 'Please enter your date of birth';
        isValid = false;
    }
    
    if (!phoneInput.value || phoneInput.value.length !== 10) {
        document.getElementById('phoneError').textContent = 'Please enter a valid 10-digit phone number';
        isValid = false;
    }
    
    if (isValid) {
        try {
            const response = await fetch('/api/complete-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    citizenship: citizenshipInput.value,
                    dateOfBirth: dateInput.value,
                    phoneNumber: phoneInput.value,
                }),
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Redirect to organization setup or dashboard
                window.location.href = '/organization-setup';
            } else {
                throw new Error(data.error || 'Failed to complete profile');
            }
        } catch (error) {
            alert(error.message);
        }
    }
});
</script>
{% endblock %} 