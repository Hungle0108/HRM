{% extends "base.html" %}

{% block title %}Edit Personal Details - HR Management System{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
<style>
    .edit-details-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        background: white;
        border-radius: 8px;
        padding: 2rem;
        margin: 2rem auto;
        max-width: 1200px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .details-section {
        flex: 2;
    }

    .avatar-section {
        text-align: center;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 8px;
        height: fit-content;
    }

    .avatar-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: #e9ecef;
        margin: 0 auto 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: #adb5bd;
        overflow: hidden;
    }

    .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-title {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .avatar-description {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 1.5rem;
    }

    .avatar-actions {
        display: none;
    }

    .avatar-actions.has-photo {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .btn-upload {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: #000;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .btn-upload:hover {
        background: #333;
    }

    .btn-remove {
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid #dc3545;
        color: #dc3545;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .btn-remove:hover {
        background: #dc3545;
        color: white;
    }

    .edit-details-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 2rem;
        color: #333;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #666;
        font-size: 0.9rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .form-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    /* Date input wrapper and calendar icon styles */
    .date-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .date-input {
        padding-right: 50px !important;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
    }

    .date-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .calendar-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        transition: all 0.2s;
        z-index: 1;
    }

    .calendar-icon:hover {
        opacity: 0.8;
        transform: translateY(-50%) scale(1.05);
    }

    .calendar-icon img {
        width: 20px;
        height: 20px;
        object-fit: contain;
        transition: all 0.2s;
    }

    /* Custom Flatpickr Styles */
    .flatpickr-calendar {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        width: 360px !important;
        padding: 20px;
        border: none !important;
    }

    .flatpickr-months {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 0 5px;
        position: relative;
    }

    .flatpickr-month {
        display: flex;
        align-items: center;
        width: auto;
    }

    .flatpickr-current-month {
        display: flex;
        align-items: center;
        font-size: 18px;
        font-weight: 500;
        min-width: 250px !important;
        width: auto !important;
        max-width: none !important;
        flex-shrink: 0 !important;
        overflow: visible !important;
        justify-content: flex-start;
        order: 1;
    }

    /* HIGHEST SPECIFICITY OVERRIDES FOR MONTH DISPLAY */
    .flatpickr-calendar .flatpickr-months .flatpickr-current-month,
    .flatpickr-calendar .flatpickr-current-month {
        min-width: 250px !important; /* Increased even more to ensure space */
        width: auto !important; /* Allow it to expand as needed */
        max-width: none !important; /* Remove any max-width restrictions */
        flex-shrink: 0 !important; /* Prevent shrinking */
        overflow: visible !important; /* Ensure text isn't clipped */
    }

    .flatpickr-calendar .flatpickr-months .flatpickr-current-month .cur-month,
    .flatpickr-calendar .flatpickr-current-month .cur-month,
    .flatpickr-calendar .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-calendar .cur-month {
        min-width: 120px !important; /* Ensure enough space for "December" */
        width: auto !important; /* Allow auto-sizing */
        max-width: none !important; /* Remove restrictions */
        white-space: nowrap !important; /* Never wrap text */
        overflow: visible !important; /* Never clip text */
        text-overflow: clip !important; /* Don't add ellipsis */
        margin-right: 8px !important; /* Add more spacing */
        flex-shrink: 0 !important; /* Prevent shrinking */
        display: inline-block !important; /* Ensure proper display */
    }

    .flatpickr-calendar .flatpickr-months .flatpickr-current-month .cur-year,
    .flatpickr-calendar .flatpickr-current-month .cur-year,
    .flatpickr-calendar .cur-year,
    .flatpickr-calendar .numInput.cur-year {
        width: 50px !important; /* Fixed width for year */
        min-width: 50px !important; /* Minimum width */
        max-width: 50px !important; /* Maximum width */
        margin-left: 4px !important; /* Add spacing */
        flex-shrink: 0 !important; /* Prevent shrinking */
    }

    /* Ensure the header section has enough space */
    .flatpickr-calendar .flatpickr-months {
        padding: 0 3px !important; /* Reduce side padding to give more internal space */
        min-height: 40px !important; /* Ensure adequate height */
        width: 100% !important; /* Full width */
        overflow: visible !important; /* Allow content to overflow if needed */
    }

    /* Reduce year dropdown button margin to save space */
    .flatpickr-calendar .year-dropdown-btn {
        margin-left: 1px !important; /* Minimal margin */
        flex-shrink: 0 !important; /* Don't shrink */
    }

    /* Navigation buttons positioning and styling */
    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
        position: static;
        height: 32px;
        width: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 8px;
        order: 2;
    }

    .flatpickr-months .flatpickr-prev-month svg,
    .flatpickr-months .flatpickr-next-month svg {
        width: 20px;
        height: 20px;
        fill: none !important;
        stroke: #000;
        stroke-width: 2;
    }

    .cur-month {
        min-width: 120px !important;
        width: auto !important;
        white-space: nowrap !important;
        overflow: visible !important;
        margin-right: 8px !important;
        pointer-events: none;
        cursor: default;
    }

    .cur-year {
        width: 50px !important;
        margin-left: 4px !important;
        pointer-events: none;
        cursor: default;
        text-align: left;
    }

    .year-dropdown-btn {
        margin-left: 2px;
        padding: 2px 4px;
        background: none;
        border: none;
        cursor: pointer;
        border-radius: 3px;
        font-size: 12px;
        color: #666;
        transition: background-color 0.2s;
    }

    .year-dropdown-btn:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }

    .year-dropdown-btn.active {
        background-color: rgba(0, 0, 0, 0.15);
    }

    .year-grid {
        position: absolute;
        top: 60px !important;
        left: 15px !important;
        right: 15px !important;
        bottom: 15px !important;
        background: white;
        z-index: 1000;
        overflow-y: auto;
        overflow-x: hidden;
        display: none;
        box-sizing: border-box;
    }

    .year-grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        width: 100%;
        box-sizing: border-box;
    }

    .year-option {
        padding: 10px;
        text-align: center;
        cursor: pointer;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        background: #f8f9fa;
        transition: all 0.2s;
        border: 1px solid transparent;
        box-sizing: border-box;
        min-width: 0;
    }

    .year-option:hover {
        background-color: #e9ecef;
        border-color: #d1d5db;
        transform: translateY(-1px);
    }

    .year-option.selected {
        background-color: #000;
        color: white;
        border-color: #000;
    }

    .flatpickr-calendar.year-mode .flatpickr-days,
    .flatpickr-calendar.year-mode .flatpickr-weekdays {
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }

    .flatpickr-calendar.year-mode .flatpickr-prev-month,
    .flatpickr-calendar.year-mode .flatpickr-next-month {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }

    /* Force hide with maximum specificity - this will override any other styles */
    .flatpickr-calendar.year-mode .flatpickr-months .flatpickr-prev-month,
    .flatpickr-calendar.year-mode .flatpickr-months .flatpickr-next-month,
    .flatpickr-calendar.year-mode .flatpickr-prev-month,
    .flatpickr-calendar.year-mode .flatpickr-next-month {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
        position: absolute !important;
        left: -9999px !important;
        width: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
    }

    .flatpickr-calendar.year-mode {
        min-height: 400px !important;
        height: 400px !important;
        max-height: 400px !important;
        width: 360px !important;
        max-width: 360px !important;
    }

    .flatpickr-calendar.year-mode .year-grid {
        display: block !important;
    }

    .flatpickr-weekdays {
        margin: 0 0 15px 0;
        padding: 15px 0 0 0;
        display: flex;
        justify-content: space-between;
        width: 100%;
        border-top: 1px solid #eee;
    }

    .flatpickr-weekdaycontainer {
        display: flex;
        justify-content: space-between;
        width: 100%;
        padding: 0 2px;
    }

    .flatpickr-weekday {
        font-size: 14px;
        font-weight: 500;
        color: #000;
        opacity: 0.7;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px 0;
        margin: 0;
        min-width: 40px;
    }

    .flatpickr-day {
        width: 40px;
        height: 40px;
        line-height: 40px;
        font-size: 14px;
        border-radius: 50%;
        margin: 2px 0;
        color: #000;
        opacity: 0.7;
        border: none;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        flex: 0 0 40px;
    }

    .flatpickr-day:hover {
        background: #e2e2e2;
        opacity: 1;
    }

    .flatpickr-day.selected {
        background: #000;
        color: #fff;
        opacity: 1;
    }

    .flatpickr-day.prevMonthDay,
    .flatpickr-day.nextMonthDay {
        visibility: hidden;
        opacity: 0;
        pointer-events: none;
    }

    .flatpickr-calendar .flatpickr-next-month.disabled,
    .flatpickr-calendar .flatpickr-prev-month.disabled {
        opacity: 0.3 !important;
        cursor: not-allowed !important;
        pointer-events: none !important;
        filter: grayscale(100%) !important;
        /* Keep the button visible but clearly disabled */
        display: flex !important;
        visibility: visible !important;
    }

    .flatpickr-calendar .flatpickr-next-month.disabled:hover,
    .flatpickr-calendar .flatpickr-prev-month.disabled:hover {
        background: transparent !important;
        opacity: 0.3 !important;
    }

    .flatpickr-calendar .flatpickr-next-month.disabled svg,
    .flatpickr-calendar .flatpickr-prev-month.disabled svg {
        color: #ccc !important;
        opacity: 0.5 !important;
    }

    /* Remove the overlay styling since we want the button to remain visible */
    .flatpickr-calendar .flatpickr-next-month.disabled::after,
    .flatpickr-calendar .flatpickr-prev-month.disabled::after {
        display: none !important;
    }

    .flatpickr-calendar .flatpickr-next-month:not(.disabled),
    .flatpickr-calendar .flatpickr-prev-month:not(.disabled) {
        opacity: 1 !important;
        cursor: pointer !important;
        pointer-events: auto !important;
        filter: none !important;
    }

    .flatpickr-calendar .flatpickr-next-month:not(.disabled):hover,
    .flatpickr-calendar .flatpickr-prev-month:not(.disabled):hover {
        background: rgba(0, 0, 0, 0.1) !important;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-cancel {
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        border-radius: 4px;
        color: #666;
        cursor: pointer;
    }

    .btn-cancel:hover {
        background: #eaeaea;
    }

    .btn-save {
        padding: 0.5rem 1rem;
        background: #000;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-save:hover {
        background: #333;
    }

    .form-hint {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.25rem;
    }

    .dropdown-wrapper {
        position: relative;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
    }

    .dropdown-menu.show {
        display: block;
    }

    .dropdown-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        color: #333;
    }

    .dropdown-item:hover {
        background: #f3f4f6;
    }

    .phone-input-group {
        display: flex;
        gap: 0.5rem;
    }

    .phone-prefix {
        width: 80px;
    }

    .hidden {
        display: none;
    }

    .avatar-form {
        margin-bottom: 1rem;
    }

    .avatar-actions-container {
        margin-top: 1rem;
    }

    /* Hide any remaining toggle indicators */
    .numInputWrapper::after,
    .flatpickr-current-month .cur-month::after,
    .flatpickr-current-month .flatpickr-monthDropdown-months::after,
    .flatpickr-current-month select::after,
    .flatpickr-current-month select::-ms-expand {
        display: none !important;
    }

    .flatpickr-current-month select,
    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .numInput.cur-year {
        background: transparent !important;
        border: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
        pointer-events: none !important;
        cursor: default !important;
        padding: 0;
        width: 60px !important;
        text-align: left !important;
        font-variant-numeric: tabular-nums !important;
        letter-spacing: 0 !important;
        margin: 0 !important;
        display: inline-block !important;
    }

    /* Hide default year navigation arrows */
    .flatpickr-current-month .numInputWrapper::after,
    .flatpickr-current-month .numInputWrapper::before {
        display: none !important;
    }

    .flatpickr-current-month .arrowUp,
    .flatpickr-current-month .arrowDown {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-details-container">
    <div class="details-section">
        <h2 class="edit-details-title">Edit personal details</h2>
        
        <form id="personalDetailsForm">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Legal first name</label>
                    <input type="text" class="form-input" id="firstName" value="{{ user.first_name }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Legal last name</label>
                    <input type="text" class="form-input" id="lastName" value="{{ user.last_name }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Preferred name (optional)</label>
                    <input type="text" class="form-input" id="preferredName" value="{{ user.preferred_name or '' }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Date of birth (DD/MM/YYYY)</label>
                    <div class="date-input-wrapper">
                        <input type="text" class="form-input date-input" id="dateOfBirth" value="{{ user.date_of_birth or '' }}" readonly>
                        <button type="button" class="calendar-icon" id="calendarToggle">
                            <img src="{{ url_for('static', filename='images/calendar-lines.png') }}" alt="Calendar">
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">I'm a citizen of</label>
                <div class="dropdown-wrapper">
                    <input type="text" class="form-input" id="citizenship" value="{{ user.citizenship }}" placeholder="Start typing your citizenship">
                    <div class="dropdown-menu" id="citizenshipDropdown"></div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Phone number</label>
                <div class="phone-input-group">
                    <input type="text" class="form-input phone-prefix" value="+84" readonly>
                    <input type="text" class="form-input" id="phone" value="{{ user.phone or '' }}" placeholder="Enter your phone number" pattern="[0-9]*" inputmode="numeric">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" value="{{ user.email }}" readonly>
                <div class="form-hint">To change your email, please contact support</div>
            </div>

            <div class="form-group">
                <label class="form-label">Country of tax residence</label>
                <div class="dropdown-wrapper">
                    <input type="text" class="form-input" id="taxResidence" value="{{ user.tax_residence or '' }}" placeholder="Start typing your tax residence">
                    <div class="dropdown-menu" id="taxResidenceDropdown"></div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="window.location.href='/profile/settings'">Cancel</button>
                <button type="submit" class="btn-save">Save</button>
            </div>
        </form>
    </div>

    <div class="avatar-section">
        <div class="avatar-preview" id="avatarPreview">
            {% if user.avatar_url %}
                <img src="{{ user.avatar_url }}" alt="Profile photo">
            {% else %}
                {{ user.first_name[0] if user.first_name else 'Q' }}
            {% endif %}
        </div>
        <h3 class="avatar-title">Make it easier for people to recognize you.</h3>
        <p class="avatar-description">Your photo will be visible to your clients and coworkers on Deel.</p>
        
        <form id="avatarForm" class="avatar-form {% if user.avatar_url %}hidden{% endif %}" enctype="multipart/form-data">
            <input type="file" id="avatarInput" accept="image/*" class="hidden">
            <button type="button" class="btn-upload" onclick="document.getElementById('avatarInput').click()">
                Add a photo
            </button>
        </form>

        <div class="avatar-actions {% if user.avatar_url %}has-photo{% endif %} avatar-actions-container" id="avatarActions">
            <button type="button" class="btn-upload" onclick="document.getElementById('avatarInput').click()">
                Update photo
            </button>
            <button type="button" class="btn-remove" onclick="removePhoto()">
                Remove photo
            </button>
        </div>
    </div>
</div>

<script>
const countries = [
    'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria', 'Azerbaijan',
    'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan', 'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi',
    'Cabo Verde', 'Cambodia', 'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czech Republic',
    'Denmark', 'Djibouti', 'Dominica', 'Dominican Republic',
    'Ecuador', 'Egypt', 'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini', 'Ethiopia',
    'Fiji', 'Finland', 'France',
    'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau', 'Guyana',
    'Haiti', 'Honduras', 'Hungary',
    'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Italy', 'Ivory Coast',
    'Jamaica', 'Japan', 'Jordan',
    'Kazakhstan', 'Kenya', 'Kiribati', 'Kuwait', 'Kyrgyzstan',
    'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania', 'Luxembourg',
    'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta', 'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar',
    'Namibia', 'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Korea', 'North Macedonia', 'Norway',
    'Oman',
    'Pakistan', 'Palau', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal',
    'Qatar',
    'Romania', 'Russia', 'Rwanda',
    'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino', 'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia', 'South Africa', 'South Korea', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria',
    'Taiwan', 'Tajikistan', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu',
    'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan',
    'Vanuatu', 'Vatican City', 'Venezuela', 'Vietnam',
    'Yemen',
    'Zambia', 'Zimbabwe'
];

function setupDropdown(inputId, dropdownId) {
    const input = document.getElementById(inputId);
    const dropdown = document.getElementById(dropdownId);
    let selectedValue = input.value;

    function filterCountries(searchText) {
        return countries.filter(country => 
            country.toLowerCase().includes(searchText.toLowerCase())
        );
    }

    function updateDropdown(filteredCountries) {
        dropdown.innerHTML = '';
        
        if (filteredCountries.length > 0) {
            filteredCountries.forEach(country => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.textContent = country;
                div.addEventListener('click', () => {
                    input.value = country;
                    selectedValue = country;
                    dropdown.classList.remove('show');
                });
                dropdown.appendChild(div);
            });
            dropdown.classList.add('show');
        } else {
            dropdown.classList.remove('show');
        }
    }

    input.addEventListener('input', (e) => {
        const searchText = e.target.value;
        const filteredCountries = filterCountries(searchText);
        updateDropdown(filteredCountries);
    });

    input.addEventListener('focus', () => {
        if (input.value) {
            const filteredCountries = filterCountries(input.value);
            updateDropdown(filteredCountries);
        } else {
            updateDropdown(countries);
        }
    });

    document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('show');
        }
    });
}

// Set up dropdowns for both citizenship and tax residence
setupDropdown('citizenship', 'citizenshipDropdown');
setupDropdown('taxResidence', 'taxResidenceDropdown');

// Initialize date picker with calendar icon
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('dateOfBirth');
    const calendarToggle = document.getElementById('calendarToggle');

    if (dateInput && calendarToggle) {
        const fp = flatpickr(dateInput, {
            dateFormat: "Y-m-d",
            maxDate: new Date(),
            minDate: "1900-01-01",
            defaultDate: dateInput.value || null,
            clickOpens: false,
            allowInput: false,
            static: false,
            showMonths: 1,
            disableMobile: true,
            onMonthChange: function(selectedDates, dateStr, instance) {
                setTimeout(() => {
                    checkAndDisableNavigation(instance);
                    setupYearDropdown(instance);
                }, 10);
            },
            onYearChange: function(selectedDates, dateStr, instance) {
                setTimeout(() => {
                    checkAndDisableNavigation(instance);
                    setupYearDropdown(instance);
                }, 10);
            },
            onOpen: function(selectedDates, dateStr, instance) {
                setTimeout(() => {
                    checkAndDisableNavigation(instance);
                    setupYearDropdown(instance);
                }, 10);
            },
            onReady: function(selectedDates, dateStr, instance) {
                setTimeout(() => {
                    checkAndDisableNavigation(instance);
                    setupYearDropdown(instance);
                }, 10);
            }
        });

        // Function to check and disable future navigation
        function checkAndDisableNavigation(instance) {
            if (!instance || !instance.calendarContainer) return;
            
            const calendar = instance.calendarContainer;
            const nextButton = calendar.querySelector('.flatpickr-next-month');
            const prevButton = calendar.querySelector('.flatpickr-prev-month');
            
            if (nextButton && prevButton) {
                const currentMonth = instance.currentMonth;
                const currentYear = instance.currentYear;
                const today = new Date();
                const nextMonth = new Date(currentYear, currentMonth + 1, 1);
                const prevMonth = new Date(currentYear, currentMonth - 1, 1);
                
                if (nextMonth > today) {
                    nextButton.classList.add('disabled');
                    nextButton.style.opacity = '0.3';
                    nextButton.style.cursor = 'not-allowed';
                    nextButton.style.pointerEvents = 'none';
                } else {
                    nextButton.classList.remove('disabled');
                    nextButton.style.opacity = '1';
                    nextButton.style.cursor = 'pointer';
                    nextButton.style.pointerEvents = 'auto';
                }
                
                const minDate = new Date(1900, 0, 1);
                if (prevMonth < minDate) {
                    prevButton.classList.add('disabled');
                    prevButton.style.opacity = '0.3';
                    prevButton.style.cursor = 'not-allowed';
                    prevButton.style.pointerEvents = 'none';
                } else {
                    prevButton.classList.remove('disabled');
                    prevButton.style.opacity = '1';
                    prevButton.style.cursor = 'pointer';
                    prevButton.style.pointerEvents = 'auto';
                }
            }
        }

        // Function to setup year dropdown functionality
        function setupYearDropdown(instance) {
            if (!instance || !instance.calendarContainer) return;
            
            const calendar = instance.calendarContainer;
            const currentMonthContainer = calendar.querySelector('.flatpickr-current-month');
            
            if (!currentMonthContainer) return;
            
            const existingDropdownBtn = currentMonthContainer.querySelector('.year-dropdown-btn');
            const existingYearGrid = calendar.querySelector('.year-grid');
            if (existingDropdownBtn) existingDropdownBtn.remove();
            if (existingYearGrid) existingYearGrid.remove();
            
            const yearDropdownBtn = document.createElement('button');
            yearDropdownBtn.className = 'year-dropdown-btn';
            yearDropdownBtn.innerHTML = '▼';
            yearDropdownBtn.type = 'button';
            
            const yearGrid = document.createElement('div');
            yearGrid.className = 'year-grid';
            
            const yearGridContainer = document.createElement('div');
            yearGridContainer.className = 'year-grid-container';
            
            const currentYear = instance.currentYear;
            const maxYear = new Date().getFullYear();
            const minYear = 1900;
            
            for (let year = maxYear; year >= minYear; year--) {
                const yearOption = document.createElement('div');
                yearOption.className = 'year-option';
                yearOption.textContent = year;
                
                if (year === currentYear) {
                    yearOption.classList.add('selected');
                }
                
                yearOption.addEventListener('click', () => {
                    instance.changeYear(year);
                    calendar.classList.remove('year-mode');
                    yearDropdownBtn.classList.remove('active');
                    yearDropdownBtn.innerHTML = '▼';
                });
                
                yearGridContainer.appendChild(yearOption);
            }
            
            yearGrid.appendChild(yearGridContainer);
            
            yearDropdownBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const isYearMode = calendar.classList.contains('year-mode');
                
                if (isYearMode) {
                    calendar.classList.remove('year-mode');
                    yearDropdownBtn.classList.remove('active');
                    yearDropdownBtn.innerHTML = '▼';
                } else {
                    calendar.classList.add('year-mode');
                    yearDropdownBtn.classList.add('active');
                    yearDropdownBtn.innerHTML = '▲';
                    
                    const yearOptions = yearGrid.querySelectorAll('.year-option');
                    yearOptions.forEach(option => {
                        option.classList.remove('selected');
                        if (parseInt(option.textContent) === instance.currentYear) {
                            option.classList.add('selected');
                        }
                    });
                    
                    setTimeout(() => {
                        const selectedOption = yearGrid.querySelector('.year-option.selected');
                        if (selectedOption) {
                            selectedOption.scrollIntoView({ block: 'center', behavior: 'smooth' });
                        }
                    }, 10);
                }
            });
            
            currentMonthContainer.appendChild(yearDropdownBtn);
            calendar.appendChild(yearGrid);
        }

        // Override the default click handlers to respect our disabled state
        const originalNextMonth = fp.nextMonth;
        const originalPrevMonth = fp.prevMonth;
        
        fp.nextMonth = function() {
            if (!fp.calendarContainer) return;
            
            const calendar = fp.calendarContainer;
            const nextButton = calendar.querySelector('.flatpickr-next-month');
            
            if (nextButton && !nextButton.classList.contains('disabled')) {
                originalNextMonth.call(fp);
                setTimeout(() => {
                    checkAndDisableNavigation(fp);
                    setupYearDropdown(fp);
                }, 10);
            }
        };
        
        fp.prevMonth = function() {
            if (!fp.calendarContainer) return;
            
            const calendar = fp.calendarContainer;
            const prevButton = calendar.querySelector('.flatpickr-prev-month');
            
            if (prevButton && !prevButton.classList.contains('disabled')) {
                originalPrevMonth.call(fp);
                setTimeout(() => {
                    checkAndDisableNavigation(fp);
                    setupYearDropdown(fp);
                }, 10);
            }
        };

        // Calendar icon click handler
        calendarToggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fp.toggle();
        });

        // Initial setup
        setTimeout(() => {
            checkAndDisableNavigation(fp);
            setupYearDropdown(fp);
        }, 50);
    }

    // Clear any stored avatar URL if user has no avatar
    if (!('{{ user.avatar_url }}')) {
        localStorage.removeItem('userAvatarUrl');
        if (typeof updateAvatarDisplay === 'function') {
            updateAvatarDisplay(null);
        }
    }
});

document.getElementById('personalDetailsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const phoneInput = document.getElementById('phone');
    // Remove leading zeros and convert back to string
    const phoneValue = String(parseInt(phoneInput.value || '0', 10));
    
    const data = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        preferred_name: document.getElementById('preferredName').value,
        date_of_birth: document.getElementById('dateOfBirth').value,
        citizenship: document.getElementById('citizenship').value,
        phone: phoneValue,
        tax_residence: document.getElementById('taxResidence').value
    };

    try {
        const response = await fetch('/api/update-personal-details', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            // Get the current avatar URL from the preview image
            const previewImg = document.querySelector('#avatarPreview img');
            const avatarUrl = previewImg ? previewImg.src : null;

            // Now sync the avatar with the taskbar
            window.dispatchEvent(new CustomEvent('avatarUpdated', {
                detail: { avatarUrl: avatarUrl }
            }));

            // Update all avatar instances
            if (typeof updateAvatarDisplay === 'function') {
                updateAvatarDisplay(avatarUrl);
            }

            // Redirect after syncing
            window.location.href = '/profile/settings';
        } else {
            const errorData = await response.json();
            alert(errorData.error || 'Failed to update personal details');
        }
    } catch (error) {
        alert('An error occurred while updating personal details');
    }
});

// Add event handler for phone input to remove leading zeros on blur
document.getElementById('phone').addEventListener('blur', function(e) {
    if (this.value) {
        // Remove leading zeros and update the input value
        this.value = String(parseInt(this.value, 10));
    }
});

document.getElementById('avatarInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('avatar', file);

    try {
        const response = await fetch('/api/upload-avatar', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            
            // Update only the preview
            const preview = document.getElementById('avatarPreview');
            preview.innerHTML = `<img src="${data.avatar_url}" alt="Profile photo">`;
            
            // Update form display
            document.getElementById('avatarForm').style.display = 'none';
            document.getElementById('avatarActions').classList.add('has-photo');
        } else {
            const errorData = await response.json();
            alert(errorData.error || 'Failed to upload photo');
        }
    } catch (error) {
        alert('An error occurred while uploading the photo');
    }
});

async function removePhoto() {
    try {
        const response = await fetch('/api/remove-avatar', {
            method: 'POST'
        });

        if (response.ok) {
            // Update only the preview
            const preview = document.getElementById('avatarPreview');
            preview.innerHTML = '{{ user.first_name[0] if user.first_name else "Q" }}';
            
            // Update form display
            document.getElementById('avatarForm').style.display = 'block';
            document.getElementById('avatarActions').classList.remove('has-photo');
        } else {
            const errorData = await response.json();
            alert(errorData.error || 'Failed to remove photo');
        }
    } catch (error) {
        alert('An error occurred while removing the photo');
    }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
{% endblock %} 