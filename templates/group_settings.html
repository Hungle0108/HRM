{% extends "base.html" %}

{% block title %}Group Settings | HRM{% endblock %}

{% block styles %}
<style>
.group-settings-container {
    max-width: 1200px;
    margin: 32px auto 0 auto;
    padding: 0 24px 48px 24px;
}
.group-settings-header {
    margin-bottom: 24px;
}
.group-settings-back {
    color: #222;
    font-size: 0.95rem;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 18px;
    font-weight: 500;
}
.group-settings-title-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 8px;
}
.group-settings-title {
    font-size: 2rem;
    font-weight: 600;
    color: #222;
}
.status-badge {
    background: #e6f7ec;
    color: #1ca97a;
    font-size: 0.95rem;
    font-weight: 500;
    border-radius: 16px;
    padding: 4px 14px;
    display: inline-block;
    margin-left: 4px;
}
.group-settings-tabs {
    display: flex;
    gap: 32px;
    margin-bottom: 32px;
}
.group-settings-tab {
    font-size: 1.05rem;
    color: #222;
    padding: 12px 0;
    cursor: pointer;
    border: none;
    background: none;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    transition: border 0.2s;
}
.group-settings-tab.active {
    border-bottom: 2px solid #222;
    color: #222;
}
.group-settings-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}
@media (max-width: 900px) {
    .group-settings-cards {
        grid-template-columns: 1fr;
    }
}
.group-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 24px 24px 18px 24px;
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
    gap: 18px;
}
.group-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}
.group-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #222;
}
.group-card-edit-btn {
    background: #f5f5f5;
    border: none;
    border-radius: 8px;
    padding: 6px 18px;
    font-size: 1rem;
    color: #222;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}
.group-card-edit-btn:hover {
    background: #ececec;
}
.group-card-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fafbfc;
    border-radius: 8px;
    padding: 14px 18px;
    font-size: 1rem;
    color: #222;
}
.group-card-row-label {
    color: #888;
    font-size: 1rem;
}
.group-card-row-value {
    font-weight: 500;
}
.group-card-info {
    color: #666;
    font-size: 0.98rem;
    margin-bottom: 0;
}
.group-card-link {
    color: #1a73e8;
    text-decoration: underline;
    font-size: 0.98rem;
}
.group-card-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 8px 0 0 0;
}
.group-card-toggle-label {
    font-size: 1rem;
    color: #222;
    font-weight: 500;
}
.group-card-toggle-new {
    background: #e6e6fa;
    color: #7c3aed;
    font-size: 0.8rem;
    font-weight: 600;
    border-radius: 8px;
    padding: 2px 8px;
    margin-left: 8px;
}
.group-card-policy-btn {
    background: #f5f5f5;
    border: none;
    border-radius: 8px;
    padding: 7px 18px;
    font-size: 1rem;
    color: #222;
    font-weight: 500;
    cursor: pointer;
    margin-top: 8px;
    margin-right: 8px;
    transition: background 0.2s;
}
.group-card-policy-btn:hover {
    background: #ececec;
}
.group-card-policy-default {
    color: #888;
    font-size: 1rem;
    font-weight: 500;
    margin-left: 8px;
}
.group-card-archive-btn {
    background: #fff;
    border: 1.5px solid #222;
    border-radius: 8px;
    padding: 8px 22px;
    font-size: 1rem;
    color: #222;
    font-weight: 500;
    cursor: pointer;
    margin-top: 8px;
    transition: background 0.2s, border 0.2s;
}
.group-card-archive-btn:hover {
    background: #f5f5f5;
    border-color: #888;
}
.group-name-row {
    background: #e5e7eb;
    border: 2px solid #b0b3b8;
    color: #222;
    font-size: 1.08rem;
    font-weight: 600;
    box-shadow: none;
}

/* Table styles from worker type page */
.worker-types-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border: none;
    border-radius: 0;
    overflow: visible;
}

.worker-types-table th {
    padding: 16px;
    text-align: left;
    font-size: 0.875rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #e9ecef;
    border-right: 1px solid #e9ecef;
    background: #f8f9fa;
    user-select: none;
    position: relative;
    transition: background-color 0.2s ease;
}

.worker-types-table th .sort-icon {
    display: inline-block;
    margin-left: 8px;
    width: 12px;
    height: 12px;
    opacity: 0;
    transition: opacity 0.2s ease;
    vertical-align: baseline;
    transform: translateY(-2px);
    cursor: pointer;
}

.worker-types-table th .sort-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    vertical-align: middle;
    transition: none;
}

.worker-types-table th.sortable:hover .sort-icon,
.worker-types-table th.sorted .sort-icon {
    opacity: 1;
}

.worker-types-table th:last-child {
    border-right: none;
}

.worker-types-table td {
    padding: 16px;
    border-bottom: 1px solid #e9ecef;
    border-right: 1px solid #e9ecef;
    font-size: 0.875rem;
    color: #495057;
    vertical-align: middle;
}

.worker-types-table td:last-child {
    border-right: none;
}

.worker-types-table tr:last-child td {
    border-bottom: none;
}

.worker-types-table tr:hover {
    background: #f8f9fa;
}

.worker-types-table thead tr:first-child th:first-child {
    border-top-left-radius: 0;
}

.worker-types-table thead tr:first-child th:last-child {
    border-top-right-radius: 0;
}

.worker-types-table tbody tr:last-child td:first-child {
    border-bottom-left-radius: 12px;
}

.worker-types-table tbody tr:last-child td:last-child {
    border-bottom-right-radius: 12px;
}

/* Edit button styles */
.edit-btn {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    opacity: 0.7;
}

.edit-btn:hover {
    background: #f8f9fa;
    opacity: 1;
    transform: scale(1.1);
}

.edit-btn:active {
    transform: scale(0.95);
}

/* Actions column width */
.worker-types-table td:last-child,
.worker-types-table th:last-child {
    width: 60px;
    text-align: center;
    padding: 12px 8px;
    position: relative;
}

/* Actions container */
.actions-container {
    position: relative;
    display: inline-block;
}

/* Action menu popup */
.action-menu {
    position: fixed;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 999;
    min-width: 120px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    overflow: hidden;
}

.action-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

/* Action menu items */
.action-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 0.875rem;
    color: #495057;
}

.action-item:hover {
    background-color: #f8f9fa;
}

.action-item.delete {
    color: #dc3545;
}

.action-item.delete:hover {
    background-color: #f8f9fa;
    color: #dc3545;
}

.action-icon {
    width: 16px;
    height: 16px;
    margin-right: 8px;
    opacity: 0.7;
}

.action-item:hover .action-icon {
    opacity: 1;
}

.action-item.delete .action-icon {
    filter: brightness(0) saturate(100%) invert(24%) sepia(92%) saturate(4159%) hue-rotate(347deg) brightness(91%) contrast(92%);
}

/* Table wrapper and summary */
.table-wrapper {
    border-radius: 12px;
    overflow: visible;
}

.table-summary {
    background: white;
    color: #6c757d;
    font-size: 0.875rem;
    padding: 16px 24px;
    border-bottom: 1px solid #e9ecef;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
}

/* Search container styles */
.search-container {
    position: relative;
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: #f8f9fa;
    transition: width 0.3s cubic-bezier(.4,0,.2,1), background 0.2s;
    box-shadow: 0 0 0 1.5px #e0e0e0;
    cursor: pointer;
    overflow: hidden;
}
.search-container.expanded {
    width: 340px;
    background: #f8f9fa;
    cursor: auto;
}
.search-input {
    width: 0;
    opacity: 0;
    border: none;
    outline: none;
    background: transparent;
    font-size: 0.875rem;
    padding: 0;
    margin: 0;
    height: 40px;
    position: absolute;
    left: 0;
    top: 0;
    transition: width 0.3s cubic-bezier(.4,0,.2,1), opacity 0.2s, padding 0.2s;
}
.search-container.expanded .search-input {
    width: calc(100% - 40px);
    opacity: 1;
    background: #f8f9fa;
    padding: 10px 16px 10px 40px;
    margin: 0;
}
.search-icon {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 18px;
    height: 18px;
    opacity: 0.6;
    pointer-events: none;
    z-index: 2;
    transition: left 0.3s cubic-bezier(.4,0,.2,1), transform 0.3s cubic-bezier(.4,0,.2,1);
}
.search-container.expanded .search-icon {
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state-title {
    font-size: 1.125rem;
    font-weight: 500;
    color: #495057;
    margin-bottom: 8px;
}

.empty-state-description {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0;
}

.filters-box {
    background: white;
    border-radius: 12px;
    padding: 24px 32px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
    position: relative;
    z-index: 1;
}
#adminTable td:nth-child(3) {
    color: #222 !important;
}
.admin-checkbox {
    margin-right: 0;
    width: 16px;
    height: 16px;
    accent-color: #1a1a1a;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url('/static/images/box.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    cursor: pointer;
    position: relative;
    border-radius: 3px;
    border: none;
    outline: none;
    transition: background 0.2s;
}
.admin-checkbox:checked {
    background-image: none;
    background-color: #1a1a1a;
}
.admin-checkbox:checked::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    width: 4px;
    height: 8px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: translate(-50%, -65%) rotate(45deg);
}
.admin-checkbox:indeterminate {
    background-image: none;
    background-color: #1a1a1a;
}
.admin-checkbox:indeterminate::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    width: 8px;
    height: 2px;
    background: white;
    transform: translate(-50%, -50%);
    border: none;
}
#adminSelectAll.admin-checkbox:checked {
    /* Hide the checkmark for select all */
}

/* Remove Admin Modal Styles */
.remove-admin-modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.3);
    z-index: 2000;
    display: none;
}
.remove-admin-modal-overlay.show {
    display: block;
}
.remove-admin-modal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 4px 32px rgba(0,0,0,0.18);
    width: 400px;
    max-width: 95vw;
    z-index: 2100;
    padding: 0;
    display: none;
}
.remove-admin-modal.show {
    display: block;
}
.remove-admin-modal-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 28px 32px 0 32px;
    position: relative;
}
.remove-admin-modal-header-spacer {
    width: 24px;
    height: 24px;
    display: flex;
}
.remove-admin-modal-header-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.remove-admin-modal-title {
    text-align: center;
    width: 100%;
    font-weight: 700;
    font-size: 1.5rem;
    color: #111;
}
.remove-admin-modal-subtitle {
    text-align: center;
    width: 100%;
    font-weight: 400;
    font-size: 1rem;
    color: #444;
}
.remove-admin-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #666;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
}
.remove-admin-modal-warning {
    background: #fff8e1;
    border: 1.5px solid #ffe082;
    color: #b26a00;
    border-radius: 8px;
    padding: 14px 18px;
    margin: 24px 32px 0 32px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    font-size: 0.98rem;
}
.remove-admin-modal-warning-icon {
    font-size: 1.2rem;
    margin-top: 2px;
}
.remove-admin-modal-admin {
    background: #f6f7fa;
    border-radius: 10px;
    margin: 24px 32px 0 32px;
    padding: 16px 18px;
    display: flex;
    align-items: center;
    gap: 16px;
}
.remove-admin-modal-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    font-weight: 700;
    color: #7c3aed;
}
.remove-admin-modal-admin-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.remove-admin-modal-admin-name {
    font-weight: 600;
    color: #222;
    font-size: 1.05rem;
}
.remove-admin-modal-admin-role {
    color: #888;
    font-size: 0.98rem;
}
.remove-admin-modal-footer {
    padding: 28px 32px 32px 32px;
}
.remove-admin-modal-remove-btn {
    width: 100%;
    background: #e53935;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1.08rem;
    font-weight: 600;
    padding: 13px 0;
    cursor: pointer;
    transition: background 0.2s;
}
.remove-admin-modal-remove-btn:hover {
    background: #c62828;
}
</style>
{% endblock %}

{% block content %}
<div class="group-settings-container">
    <div class="group-settings-header">
        <a href="/groups" class="group-settings-back">&larr; Back to Groups</a>
        <div class="group-settings-title-row">
            <span class="group-settings-title">fdsfasd</span>
            <span class="status-badge">ACTIVE</span>
        </div>
        <div class="group-settings-tabs" id="groupSettingsTabs">
            <button class="group-settings-tab active" data-tab="details">Group Details</button>
            <button class="group-settings-tab" data-tab="payment">Payment Methods</button>
            <button class="group-settings-tab" data-tab="admins">Admins (1)</button>
        </div>
    </div>
    <div id="tab-content-details">
        <div class="group-settings-cards">
            <div class="group-card">
                <div class="group-card-header">
                    <span class="group-card-title">Group details</span>
                    <button class="group-card-edit-btn">Edit</button>
                </div>
                <div class="group-card-row group-name-row">
                    <span class="group-card-row-label">Group name</span>
                    <span class="group-card-row-value">fdsfasd</span>
                </div>
            </div>
            <div class="group-card">
                <div class="group-card-header">
                    <span class="group-card-title">Archive this group</span>
                </div>
                <div class="group-card-info">
                    Archived groups are hidden from your main view but can be accessed by enabling the 'Archived' filter on your groups page. You can restore it at any time.
                </div>
                <button class="group-card-archive-btn">Archive group</button>
            </div>
        </div>
    </div>
    <div id="tab-content-admins" style="display:none;">
        <div class="filters-box" style="margin-bottom: 18px;">
            <div class="admin-table-controls" style="display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1; max-width: 340px;">
                    <div class="search-container" id="adminSearchContainer" style="position: relative;">
                        <img src="/static/images/search.png" alt="Search" class="search-icon" id="adminSearchIcon" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; opacity: 0.6;">
                        <input class="search-input" type="text" placeholder="Search by name or email..." id="adminSearchInput" style="width: 100%; padding: 10px 16px 10px 40px; border-radius: 8px; border: 1px solid #e9ecef; background: #f8f9fa;">
                        <button class="search-clear-btn" id="adminSearchClearBtn" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; display: none;">
                            <img src="/static/images/cross.png" alt="Clear" style="width: 16px; height: 16px;">
                        </button>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button id="adminActionBtn" class="group-card-edit-btn" style="background: #222; color: #fff; font-weight: 600; margin-left: 12px;">Assign admins</button>
                    <button class="group-card-edit-btn" style="padding: 6px 10px; background: #f5f5f5; color: #222;">
                        <img src="/static/images/expand.png" alt="Fullscreen" style="width: 18px; height: 18px;">
                    </button>
                </div>
            </div>
        </div>
        <div class="table-wrapper" style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div class="table-summary" id="adminTableSummary">Total 1 item</div>
            <table class="worker-types-table" id="adminTable">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" class="admin-checkbox" id="adminSelectAll"></th>
                        <th class="sortable" data-sort="name">Admin
                            <span class="sort-icon"><img src="/static/images/arrow-small-up.png" alt="Sort"></span>
                        </th>
                        <th class="sortable" data-sort="role">Role
                            <span class="sort-icon"><img src="/static/images/arrow-small-up.png" alt="Sort"></span>
                        </th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody id="adminTableBody">
                    {% for admin in admins %}
                    <tr data-admin-id="{{ admin.id }}">
                        <td><input type="checkbox" class="admin-checkbox admin-row-checkbox"></td>
                        <td style="display: flex; align-items: center; gap: 10px;">
                            <span style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: #e5e7eb; border-radius: 50%; font-weight: 700; color: #7c3aed;">{{ admin.initials }}</span>
                            <div>
                                <div style="font-weight: 600; color: #222;">{{ admin.name }}</div>
                                <div style="font-size: 0.95rem; color: #888;">{{ admin.email }}</div>
                            </div>
                        </td>
                        <td style="color: #222; font-weight: 600;">{{ admin.role }}</td>
                        <td>
                            <div class="actions-container">
                                <button class="edit-btn" onclick="toggleAdminActionMenu(event, {{ admin.id }})" title="More actions">
                                    <img src="/static/images/menu-dots-vertical.png" alt="Menu" style="width: 16px; height: 16px;">
                                </button>
                                <div class="action-menu" id="admin-menu-{{ admin.id }}">
                                    <div class="action-item remove-access" data-admin-id="{{ admin.id }}">
                                        <span style="display:inline-block;width:16px;height:16px;vertical-align:middle;margin-right:8px;">
                                            <img src="/static/images/minus-small.png" alt="Remove" style="width:16px;height:16px;vertical-align:middle;" />
                                        </span>
                                        <span>Remove access</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<!-- Update Remove Admin Modal to support single and bulk removal -->
<div class="remove-admin-modal-overlay" id="removeAdminModalOverlay"></div>
<div class="remove-admin-modal" id="removeAdminModal">
    <div class="remove-admin-modal-header">
        <span class="remove-admin-modal-header-spacer" aria-hidden="true"></span>
        <div class="remove-admin-modal-header-content">
            <div class="remove-admin-modal-title" id="removeAdminModalTitle">Remove admins</div>
            <div class="remove-admin-modal-subtitle" id="removeAdminModalSubtitle">From {{ group.name }}</div>
        </div>
        <button class="remove-admin-modal-close" id="removeAdminModalClose">&times;</button>
    </div>
    <div class="remove-admin-modal-admin" id="removeAdminModalAdminInfo"></div>
    <div class="remove-admin-modal-footer">
        <button class="remove-admin-modal-remove-btn" id="removeAdminModalRemove">Remove</button>
    </div>
</div>

<script>
// Simple tab switching logic
const tabs = document.querySelectorAll('.group-settings-tab');
const tabDetails = document.getElementById('tab-content-details');
const tabAdmins = document.getElementById('tab-content-admins');
tabs.forEach(tab => {
    tab.addEventListener('click', function() {
        tabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        if (this.dataset.tab === 'admins') {
            tabDetails.style.display = 'none';
            tabAdmins.style.display = '';
        } else {
            tabDetails.style.display = '';
            tabAdmins.style.display = 'none';
        }
    });
});

// Admin table interactivity (sorting, searching, selection, action menu)
// Remove the renderAdminTable function and all code that references adminData, since the table is now rendered by Jinja and does not need JS for static data.
// Only keep the search, sorting, and action menu logic.
// (No renderAdminTable or adminData references here)

document.getElementById('adminSearchInput').addEventListener('input', function() {
    // This function is no longer needed as the table is rendered by Jinja.
    // The search logic is handled by the Jinja template.
});
document.getElementById('adminSearchClearBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    document.getElementById('adminSearchInput').value = '';
    // This function is no longer needed as the table is rendered by Jinja.
    // The search logic is handled by the Jinja template.
});

document.querySelectorAll('#adminTable th.sortable').forEach(th => {
    th.addEventListener('click', function(e) {
        if (e.target.closest('.sort-icon')) {
            const field = this.dataset.sort;
            // This function is no longer needed as the table is rendered by Jinja.
            // The sorting logic is handled by the Jinja template.
        }
    });
});

function updateSelectAllState() {
    const selectAllCheckbox = document.getElementById('adminSelectAll');
    const rowCheckboxes = document.querySelectorAll('.admin-row-checkbox');
    const checkedCount = document.querySelectorAll('.admin-row-checkbox:checked').length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = true; // Only show horizontal line when checked
    }
}

// Add event listeners to individual row checkboxes
document.querySelectorAll('.admin-row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectAllState);
});

document.getElementById('adminSelectAll').addEventListener('change', function() {
    document.querySelectorAll('.admin-row-checkbox').forEach(cb => {
        cb.checked = this.checked;
    });
    updateSelectAllState();
    updateAdminActionBtn(); // Ensure button updates on select all/none
});

// Call updateSelectAllState on page load
updateSelectAllState();

function toggleAdminActionMenu(event, adminId) {
    event.stopPropagation();
    document.querySelectorAll('.action-menu').forEach(menu => {
        if (menu.id !== `admin-menu-${adminId}`) menu.classList.remove('show');
    });
    const menu = document.getElementById(`admin-menu-${adminId}`);
    const button = event.currentTarget;
    const buttonRect = button.getBoundingClientRect();
    
    // Position the menu relative to the button
    menu.style.top = (buttonRect.bottom + 5) + 'px';
    menu.style.left = (buttonRect.left - menu.offsetWidth) + 'px';
    
    menu.classList.toggle('show');
}
document.addEventListener('click', function(e) {
    if (!e.target.closest('.actions-container')) {
        document.querySelectorAll('.action-menu').forEach(menu => menu.classList.remove('show'));
    }
});

function editAdmin(id) { alert('Edit admin ' + id); }
function copyAdmin(id) { alert('Duplicate admin ' + id); }
function deleteAdmin(id) {
    // Remove the alert. Add your removal logic here if needed.
    // (No alert or notification)
}

// Admin search bar expand/collapse logic
const adminSearchContainer = document.getElementById('adminSearchContainer');
const adminSearchInput = document.getElementById('adminSearchInput');
const adminSearchIcon = document.getElementById('adminSearchIcon');

function expandAdminSearch() {
    adminSearchContainer.classList.add('expanded');
    setTimeout(() => {
        adminSearchInput.focus();
    }, 150);
}
function collapseAdminSearch() {
    if (adminSearchInput.value.trim() === '') {
        adminSearchContainer.classList.remove('expanded');
    }
}

adminSearchContainer.addEventListener('click', function(e) {
    if (!adminSearchContainer.classList.contains('expanded')) {
        expandAdminSearch();
    }
});
adminSearchIcon.addEventListener('click', function(e) {
    e.stopPropagation();
    if (!adminSearchContainer.classList.contains('expanded')) {
        expandAdminSearch();
    }
});
adminSearchInput.addEventListener('focus', function() {
    expandAdminSearch();
});
adminSearchInput.addEventListener('blur', function() {
    setTimeout(() => {
        collapseAdminSearch();
    }, 200);
});
adminSearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        adminSearchInput.blur();
        collapseAdminSearch();
    }
});
adminSearchInput.addEventListener('input', function() {
    if (this.value.trim() !== '') {
        adminSearchContainer.classList.add('expanded');
    }
});

// Initial render
// This function is no longer needed as the table is rendered by Jinja.
// The initial render logic is handled by the Jinja template.

let removeAdminMode = 'single'; // 'single' or 'bulk'
let adminsToRemove = [];

function showRemoveAdminModal(adminIds) {
    removeAdminMode = Array.isArray(adminIds) && adminIds.length > 1 ? 'bulk' : 'single';
    adminsToRemove = Array.isArray(adminIds) ? adminIds : [adminIds];
    const modal = document.getElementById('removeAdminModal');
    const overlay = document.getElementById('removeAdminModalOverlay');
    const adminInfoDiv = document.getElementById('removeAdminModalAdminInfo');
    const title = document.getElementById('removeAdminModalTitle');
    if (removeAdminMode === 'bulk') {
        title.textContent = 'Remove admins';
        adminInfoDiv.innerHTML = `<div style='font-size:1rem;color:#222;'>Are you sure you want to remove access for <b>${adminsToRemove.length}</b> selected admins?</div>`;
    } else {
        title.textContent = 'Remove admin';
        // Find admin info from table row
        const row = document.querySelector(`tr[data-admin-id='${adminsToRemove[0]}']`);
        if (row) {
            const avatar = row.querySelector('span[style*="border-radius: 50%"]');
            const name = row.querySelector('div[style*="font-weight: 600"]');
            const role = row.querySelector('div[style*="font-size: 0.95rem"]');
            adminInfoDiv.innerHTML = `<div class='remove-admin-modal-avatar'>${avatar ? avatar.outerHTML : ''}</div><div class='remove-admin-modal-admin-info'><div class='remove-admin-modal-admin-name'>${name ? name.textContent : ''}</div><div class='remove-admin-modal-admin-role'>${role ? role.textContent : ''}</div></div>`;
        } else {
            adminInfoDiv.innerHTML = '';
        }
    }
    modal.style.display = 'block';
    overlay.style.display = 'block';
}
function hideRemoveAdminModal() {
    document.getElementById('removeAdminModal').style.display = 'none';
    document.getElementById('removeAdminModalOverlay').style.display = 'none';
    adminsToRemove = [];
}
document.getElementById('removeAdminModalClose').onclick = hideRemoveAdminModal;
document.getElementById('removeAdminModalOverlay').onclick = hideRemoveAdminModal;
document.getElementById('removeAdminModalRemove').onclick = function() {
    if (!adminsToRemove.length) return;
    fetch(`/api/group/${groupId}/admin/bulk-remove`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_ids: adminsToRemove })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Failed to remove admin(s)');
        }
    })
    .catch(() => alert('Failed to remove admin(s)'));
};
// Dropdown Remove access
// Use modal for single admin
// Remove previous onclick assignment
document.querySelectorAll('.action-item.remove-access').forEach(item => {
    item.onclick = function() {
        const adminId = this.getAttribute('data-admin-id');
        if (!adminId) return;
        showRemoveAdminModal(adminId);
    };
});
// Bulk Remove access button
adminActionBtn.onclick = function() {
    const checked = document.querySelectorAll('.admin-row-checkbox:checked');
    if (checked.length > 0) {
        const ids = Array.from(checked).map(cb => cb.closest('tr').getAttribute('data-admin-id'));
        showRemoveAdminModal(ids);
    } else {
        window.location.href = `/assign-admin/${groupId}`;
    }
};

// Dynamic admin action button logic
const adminActionBtn = document.getElementById('adminActionBtn');
const adminCheckboxes = document.querySelectorAll('.admin-row-checkbox');
// Only declare groupId ONCE at the top
let groupId = {{ group.id }};

function updateAdminActionBtn() {
    const checked = document.querySelectorAll('.admin-row-checkbox:checked');
    if (checked.length > 0) {
        adminActionBtn.textContent = 'Remove access';
        adminActionBtn.style.background = '#f5f5f5';
        adminActionBtn.style.color = '#222';
        adminActionBtn.style.fontWeight = '500';
        adminActionBtn.style.border = 'none';
        adminActionBtn.style.boxShadow = 'none';
        adminActionBtn.style.borderRadius = '12px';
        adminActionBtn.style.padding = '8px 18px';
        adminActionBtn.onclick = function() {
            const ids = Array.from(document.querySelectorAll('.admin-row-checkbox:checked')).map(cb => cb.closest('tr').getAttribute('data-admin-id'));
            showRemoveAdminModal(ids);
        };
    } else {
        adminActionBtn.textContent = 'Assign admins';
        adminActionBtn.style.background = '#222';
        adminActionBtn.style.color = '#fff';
        adminActionBtn.style.fontWeight = '600';
        adminActionBtn.style.border = '';
        adminActionBtn.style.boxShadow = '';
        adminActionBtn.style.borderRadius = '';
        adminActionBtn.style.padding = '';
        adminActionBtn.onclick = function() {
            window.location.href = `/assign-admin/${groupId}`;
        };
    }
}
document.querySelectorAll('.admin-row-checkbox').forEach(cb => cb.addEventListener('change', updateAdminActionBtn));
document.getElementById('adminSelectAll').addEventListener('change', function() {
    document.querySelectorAll('.admin-row-checkbox').forEach(cb => {
        cb.checked = this.checked;
    });
    updateSelectAllState();
    updateAdminActionBtn();
});
updateAdminActionBtn();

document.querySelectorAll('.action-item.remove-access').forEach(item => {
    item.onclick = function() {
        const adminId = this.getAttribute('data-admin-id');
        if (!adminId) return;
        if (!confirm('Are you sure you want to remove access for this admin?')) return;
        fetch(`/api/group/${groupId}/admin/bulk-remove`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_ids: [adminId] })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.error || 'Failed to remove admin');
            }
        })
        .catch(() => alert('Failed to remove admin'));
    };
});
</script>
{% endblock %} 